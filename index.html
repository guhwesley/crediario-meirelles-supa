<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <base target="_top">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
   /* --- TELA DE LOGIN DARK (ESTILO COMPLETO) --- */

    #loginScreen {

      display: flex;

      justify-content: center;

      align-items: center;

      min-height: 100vh;

      background: #0f172a url('https://i.postimg.cc/gcZnR1Jn/mascotecred.png') no-repeat center center;

      background-size: cover;

      font-family: 'Segoe UI', sans-serif;

    }



   #loginBox {
  background: rgba(30, 41, 59, 0.85) !important; /* Cor fixa original */
  padding: 40px;
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  width: 100%;
  max-width: 420px;
  text-align: center;
  backdrop-filter: blur(10px) !important;
  -webkit-backdrop-filter: blur(10px) !important;
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

#loginBox .fa-eye, #loginBox .fa-eye-slash {
  color: white !important;
}



    #loginBox input {

      width: 100%;

      padding: 14px;

      margin-bottom: 20px;

      background: rgba(15, 23, 42, 0.7);

      border: 1px solid #334155;

      border-radius: 8px;

      box-sizing: border-box;

      display: block;

      font-size: 16px;

      color: white;

    }



    #loginBox input::placeholder {

      color: #94a3b8;

    }



    #loginBox .login-title {

      color: #ffffff;

      margin-bottom: 20px;

    }



    /* O SEU NOVO BOTÃO COM GLOW */

    .btn-login-glow {

      width: 100%;

      padding: 15px;

      margin-top: 10px;

      border: none;

      border-radius: 12px;

      background: linear-gradient(135deg, #0056b3 0%, #00a8ff 100%);

      color: white;

      font-size: 16px;

      font-weight: 800;

      letter-spacing: 1px;

      cursor: pointer;

      transition: all 0.3s ease;

      box-shadow: 0 4px 15px rgba(0, 168, 255, 0.3);

      text-transform: uppercase;

    }



    .btn-login-glow:hover {

      transform: translateY(-2px);

      box-shadow: 0 6px 20px rgba(0, 168, 255, 0.5);

      filter: brightness(1.1);

    }



    .btn-login-glow:active {

      transform: translateY(0);

    }



    .header-central { text-align: center; margin-bottom: 25px; position: relative; }

    .login-title { font-size: 32px; font-weight: 800; color: #334155; display: inline-block; font-family: 'Segoe UI', sans-serif; }

    .login-title span { color: #10b981; }

    .btn-sair { position: absolute; right: 0; top: 5px; background: #ef4444; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; }



    /* TABELA E CARDS - CORRIGIDO PARA ROLAGEM LATERAL */

    .table-container {

      background: white;

      border-radius: 10px;

      overflow-x: auto;

      box-shadow: 0 1px 3px rgba(0,0,0,0.1);

      width: 100%;

      -webkit-overflow-scrolling: touch;

    }

    table {

      width: 100%;

      border-collapse: collapse;

      white-space: nowrap;

      font-family: 'Segoe UI', sans-serif;

      min-width: 1000px; /* Mantém estrutura de PC no celular */

    }

    th, td { padding: 15px; border-bottom: 1px solid #f1f5f9; text-align: left; font-size: 13px; }

    th { background: #0056b3; color: white; }

    .col-resumo { min-width: 50px !important; width: 50px; text-align: center; padding: 5px; }



    tbody tr:nth-child(even) { background-color: #f1f5f9; }

    tbody tr:nth-child(odd) { background-color: #ffffff; }



    /* CORES DE CONDICAO ATUALIZADAS */

    .cond-paga { color: #10b981 !important; font-weight: bold; }

    .cond-atenção, .cond-atencao { color: #ffbf00 !important; font-weight: 800; }

    .cond-vencida { color: #ef4444 !important; font-weight: bold; }

   

    .pagination-container { display: flex; justify-content: center; align-items: center; gap: 20px; margin-top: 15px; padding: 10px; }

    .btn-pag { padding: 8px 16px; background: #0056b3; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }

    .btn-pag:disabled { background: #cbd5e1; cursor: not-allowed; }



    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center; font-family: 'Segoe UI', sans-serif; }

    .confirm-box, .form-box { background: white; border-radius: 20px; width: 90%; max-width: 480px; padding: 25px; text-align: left; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }

   

    .form-box h3 { color: #0056b3; font-size: 20px; margin-bottom: 20px; font-family: 'serif'; font-weight: bold; }

   



    .btn-gravar { background: #1e8449; color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 5px; }

    .btn-cancelar { background: #707b7c; color: white; width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px; }

    .btn-modal { flex: 1; padding: 15px; border-radius: 15px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; margin: 5px; }

    .card { padding: 18px; border-radius: 10px; color: white; font-weight: bold; text-align: center; cursor: pointer; }

    .nav-bar { margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; }

    .btn-nav { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }

    .btn-disabled { background: #cbd5e1 !important; cursor: not-allowed !important; opacity: 0.6; }



    /* --- TEMA DARK --- */

    body.dark-theme { background-color: #0f172a !important; color: #f1f5f9; }

    .dark-theme .confirm-box, .dark-theme .form-box { 
  background: #1e293b; 
  color: white; 
  border: 1px solid #334155; 
}

    .dark-theme .table-container { background: #1e293b; border: 1px solid #334155; }

    .dark-theme table { color: #cbd5e1; }

    .dark-theme th { background: #0f172a !important; color: #38bdf8 !important; border-bottom: 1px solid #334155; }

    .dark-theme tbody tr:nth-child(even) { background-color: #1e293b !important; }

    .dark-theme tbody tr:nth-child(odd) { background-color: #0f172a !important; }

    .dark-theme td { border-bottom: 1px solid #334155; }

    .dark-theme input, .dark-theme select { background: #0f172a; color: white; border: 1px solid #334155; }

    .dark-theme .header-central .login-title { color: #f1f5f9 !important; }



    /* FIX VIZUALIZAÇÃO RESUMO */

    #printArea { background-color: white !important; color: black !important; padding: 15px; border-radius: 8px; }

    #printArea h3 { color: #0056b3 !important; border-bottom: 2px solid #0056b3; padding-bottom: 5px; margin-top: 0; }

   

    #resumoConteudo div {

      display: flex;

      justify-content: space-between;

      border-bottom: 1px solid #eee;

      padding: 8px 0;

      color: black !important;

    }



    /* Proteção Dark Mode no Resumo */

    .dark-theme #resumoConteudo div,

    .dark-theme #resumoConteudo b,

    .dark-theme #resumoConteudo span {

      color: black !important;

    }



    .texto-verde-negrito {

  color: #10b981 !important;

  font-weight: bold;

  text-align: right;
 }

.texto-verde-negrito {
  color: #10b981 !important;
  font-weight: bold;
  text-align: right; /* Alinha números à direita como em bancos */
  white-space: nowrap;
}

/* ÁREA DO PERFIL */
.user-profile-area {
    position: absolute;
    left: 20px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
    transition: 0.3s;
    padding: 5px 10px;
    border-radius: 50px;
}
.user-profile-area:hover {
    background: rgba(16, 185, 129, 0.1);
}
.avatar-circle {
    width: 40px;
    height: 40px;
    background: #0056b3;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 18px;
    border: 2px solid #10b981;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
}
.user-info {
    text-align: left;
    display: flex;
    flex-direction: column;
    line-height: 1.2;
}
.user-info span {
    font-weight: bold;
    font-size: 14px;
    color: #334155;
    text-transform: uppercase;
}
.dark-theme .user-info span { color: #f1f5f9; }
.user-info small {
    font-size: 10px;
    color: #10b981;
    font-weight: bold;
    letter-spacing: 0.5px;
}
@media (max-width: 800px) {
    .user-profile-area { position: relative; left: 0; transform: none; margin-bottom: 15px; justify-content: center; }
}

/* CSS para o Spinner de carregamento */
.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.btn-loading {
  pointer-events: none;
  opacity: 0.8;
}

.dark-theme #loaderFiltro { color: #38bdf8 !important; }

/* Layout Full Screen */
.modal {
  display: none;
  position: fixed;
  z-index: 999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: #0f172a; /* Azul escuro de fundo */
  overflow-y: auto; /* Permite rolagem */
}

.form-box-fullscreen {
  background: #1e293b; 
  margin: 0;           /* Remove a margem para encostar nos cantos */
  padding: 30px;
  width: 100%;         /* Ocupa toda a largura */
  min-height: 100vh;   /* Ocupa toda a altura da tela */
  max-width: none;     /* Remove o limite de 1100px para cobrir tudo */
  box-sizing: border-box; /* Impede que o padding "estoure" a largura */
  box-shadow: none;    /* Remove a sombra para parecer uma página única */
}

.box-venda {
  background: #ffffff;
  color: #333;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}

/* Tabela estilizada */
.tabela-vendas {
  width: 100%;
  border-collapse: collapse;
  background: white;
  color: #333;
  border-radius: 8px;
  overflow: hidden;
}

.tabela-vendas th {
  background: #1e90ff; /* Azul da logo [cite: 7] */
  color: white;
  padding: 12px;
}

.tabela-vendas td {
  padding: 10px;
  border-bottom: 1px solid #eee;
  text-align: center;
}



/* Ajuste para não quebrar no telemóvel */
@media (max-width: 768px) {
    .venda-layout-grid {
        display: flex;
        flex-direction: column;
    }
}

/* Fixa o container da tabela como escuro */
#corpoCarrinhoContainer {
    background: #0f172a !important; /* Fundo azul marinho profundo */
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid #334155;
}

/* Fixa as cores das linhas da tabela */
.tabela-vendas-fixa {
    width: 100%;
    border-collapse: collapse;
    color: #ffffff !important; /* Texto sempre branco */
    background: #0f172a !important;
}

.tabela-vendas-fixa thead tr {
    background: #38bdf8 !important; /* Cabeçalho azul claro */
    color: #0f172a !important;      /* Texto do cabeçalho escuro para contraste */
}

.tabela-vendas-fixa td {
    padding: 12px;
    border-bottom: 1px solid #1e293b;
    color: #ffffff !important; /* Garante visibilidade das letras */
}

.subtotal-destaque {
    color: #38bdf8 !important; /* Azul brilhante para o subtotal */
    font-weight: bold;
}




/* Ajuste Total para Celular */
@media (max-width: 768px) {
  .col-pgto, .col-entrada, .col-desconto, .col-parcelas {
    flex: 1 1 100% !important; /* Cada um ocupa uma linha inteira no celular */
  }

  /* Isso impede que os campos estourem a tela no mobile */
  input, select, textarea {
    box-sizing: border-box !important; 
    width: 100% !important;
    font-size: 16px !important; /* Evita zoom indesejado no iPhone */
  }

  .form-box-fullscreen {
    padding: 15px; /* Reduz o recuo no celular para ganhar espaço */
    margin: 0;
    width: 100%;
    border-radius: 0;
  }
} 

.input-travado {
    background: rgba(15, 23, 42, 0.5) !important;
    border: 1px solid #334155 !important;
    color: #94a3b8 !important;
    cursor: default;
  }
  .input-editavel {
    background: #0f172a !important;
    border: 2px solid #10b981 !important;
    color: white !important;
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
  }

  /* Spinner e Proteção do Botão */
.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  display: inline-block;
  vertical-align: middle;
  margin-right: 8px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.btn-loading {
  pointer-events: none; /* Impede novos cliques */
  opacity: 0.8;
  cursor: not-allowed;
}

/* Container que envolve o input e o ícone */
.input-group-senha {
  position: relative;
  width: 100%;
  display: block;
}

/* Ajuste do ícone para ficar por cima do input */
.input-group-senha i {
  position: absolute;
  right: 12px;   /* Distância da borda direita */
  top: 12px;     /* Centraliza verticalmente conforme a altura do seu input */
  cursor: pointer;
  color: #666;
  z-index: 10;
  transition: color 0.3s;
}

.input-group-senha i:hover {
  color: #3b82f6; /* Muda de cor ao passar o mouse */
}

/* Garante que o texto da senha não fique "atrás" do olho */
.input-group-senha input {
  padding-right: 40px !important; 
}

/* 1. O MODAL (REVISADO E BLINDADO) */
.modal {
  display: none; /* O JS muda para flex */
  position: fixed !important;
  inset: 0 !important;
  background: rgba(0, 0, 0, 0.75) !important; /* Fundo mais escuro para foco total */
  z-index: 99999 !important; /* Valor máximo para cobrir o CRM */
  
  /* Centralização perfeita */
  align-items: center !important;
  justify-content: center !important;
}

/* 2. A CAIXA BRANCA (Adicione isso para garantir que ela apareça) */
.modal-box {
  background: white !important;
  padding: 20px !important;
  border-radius: 12px !important;
  width: 90% !important;
  max-width: 500px !important;
  box-shadow: 0 20px 50px rgba(0,0,0,0.5) !important;
  color: #333 !important;
  position: relative !important;
}

/* 3. OS BOTÕES DA TABELA (Pode manter, eles garantem o clique) */
.col-resumo, .col-resumo button {
  position: relative;
  z-index: 10;
  pointer-events: auto !important;
}

/* ============================================================
   MODAIS - VERSÃO DARK UNIFICADA (CORREÇÃO DEFINITIVA)
   ============================================================ */

/* 1. O CONTAINER PRINCIPAL DO MODAL */
.modal, #modalEdicaoCliente {
  display: none; /* Controlado pelo JS */
  position: fixed !important;
  inset: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  background: rgba(7, 10, 19, 0.95) !important; /* Fundo Black-Navy ultra escuro */
  z-index: 2147483647 !important; /* Prioridade máxima no navegador */
  align-items: center !important;
  justify-content: center !important;
  backdrop-filter: blur(4px) !important;
}

/* 2. A CAIXA DE CONTEÚDO (DESIGN DARK MODERNO) */
.modal-box, .confirm-box, .form-box {
  background: #1e293b !important; /* Azul Marinho Profundo */
  padding: 30px !important;
  border-radius: 20px !important;
  width: 90% !important;
  max-width: 500px !important;
  border: 1px solid #334155 !important;
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7) !important;
  color: #f1f5f9 !important;
  position: relative !important;
}

/* Títulos dentro dos modais */
.modal-box h3, .form-box h3 {
  color: #38bdf8 !important; /* Azul Ciano */
  font-size: 1.5rem !important;
  font-weight: 800 !important;
  margin-bottom: 20px !important;
  text-align: center !important;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Estilização dos Inputs dentro do Modal */
#modalEdicaoCliente input, .form-box input {
  background: #0f172a !important; /* Fundo mais escuro */
  color: #ffffff !important;
  border: 1px solid #334155 !important;
  padding: 12px 15px !important;
  border-radius: 8px !important;
  margin-bottom: 12px !important;
  width: 100% !important;
  font-size: 14px !important;
}

/* Labels */
#modalEdicaoCliente label {
  color: #94a3b8 !important;
  font-size: 12px !important;
  font-weight: 600 !important;
  margin-top: 8px !important;
  margin-bottom: 4px !important;
  display: block;
  text-transform: uppercase;
}

/* Botões de Ação dentro do Modal */
.btn-gravar-cliente {
  background: #10b981 !important;
  color: white !important;
  border: none !important;
  padding: 15px !important;
  border-radius: 10px !important;
  font-weight: bold !important;
  cursor: pointer !important;
  width: 100% !important;
  margin-top: 15px !important;
  transition: 0.3s !important;
}

.btn-gravar-cliente:hover {
  background: #059669 !important;
  transform: scale(1.02);
}

/* --- ESTILO PARA O MODAL DE NOVA VENDA (Diferenciado) --- */
#modalVenda {
  display: none;
  position: fixed !important;
  inset: 0 !important;
  background: #0f172a !important; 
  z-index: 99999 !important; /* Um pouco abaixo do modal de edição */
  overflow-y: auto !important;
}

/* Estilo para manter o clique funcional na tabela */
.col-resumo button {
  pointer-events: auto !important;
  cursor: pointer !important;
}

/* --- NOVO SISTEMA DE GRID E INPUTS (SUBSTITUTO) --- */
.venda-layout-grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 12px;
    align-items: end;
    margin-bottom: 20px;
}

/* Definição das Fatias */
.fatia-12 { grid-column: span 12; }
.fatia-7  { grid-column: span 7; }
.fatia-6  { grid-column: span 6; }
.fatia-5  { grid-column: span 5; }
.fatia-4  { grid-column: span 4; }
.fatia-3  { grid-column: span 3; }
.fatia-2  { grid-column: span 2; }

/* Estilo Universal para Inputs e Selects no Modal de Venda */
.venda-layout-grid input, 
.venda-layout-grid select {
    width: 100% !important;
    background: #0f172a !important;
    color: white !important;
    border: 1px solid #334155 !important;
    padding: 10px !important;
    border-radius: 8px !important;
    font-size: 0.9rem !important;
    box-sizing: border-box !important;
}

.venda-layout-grid label {
    display: block;
    color: #94a3b8;
    font-size: 0.7rem;
    margin-bottom: 5px;
    font-weight: bold;
    text-transform: uppercase;
}

/* Responsividade Automática */
@media (max-width: 768px) {
    .venda-layout-grid {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    .venda-layout-grid > div {
        width: 100% !important;
    }
}

.foto-container-tabela:hover .btn-troca-foto {
    display: flex !important;
}


</style>
</head>
<body>

 <div id="loginScreen">
  <div id="loginBox">
    <div class="login-title" style="margin-bottom: 30px; color: white;">CREDIÁRIO <span style="color: #10b981;">MEIRELLES</span></div>
    
    <input type="text" id="user" placeholder="Seu usuário, meu lindo">
    
    <div class="senha-container">
      <input type="password" id="pass" placeholder="Sua senha secreta">
      <i class="fa-solid fa-eye" id="toggleSenha" onclick="togglePass()" style="transform: translateY(-90%);"></i>
    </div>
    
    <button onclick="login()" class="btn-login-glow">ENTRAR</button>

   <div style="text-align: center; margin-top: 20px;">
  <a href="javascript:void(0)" 
     onclick="event.preventDefault(); document.getElementById('modalEsqueci').style.display='flex'" 
     style="color: #94a3b8; font-size: 0.85em; text-decoration: none; transition: 0.3s; cursor: pointer;"
     onmouseover="this.style.color='#10b981'" 
     onmouseout="this.style.color='#94a3b8'">
    <i class="fa-solid fa-unlock-keyhole"></i> Esqueci minha senha
  </a>
</div>
  </div>
</div>

  <div id="dashboard" style="display:none; padding:20px;">
      <div class="header-central">
    <div class="user-profile-area" id="userAvatarBtn" onclick="document.getElementById('modalSenha').style.display='flex'">
        <div class="avatar-circle">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="user-info">
            <span id="nomeDisplay">CARREGANDO...</span>
            <small>Painel Administrativo</small>
        </div>
    </div>

    <div class="login-title">CREDIÁRIO <span style="color:#10b981">MEIRELLES</span></div>
    
    <button onclick="logout()" class="btn-sair">Sair</button>
</div>


    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <div class="card" style="background:#0056b3" onclick="navegarLimpo('cadastro-vendas')">Total Vendas: <span id="cardVendas">0</span></div>
      <div class="card" style="background:#f59e0b" onclick="filtrarRapido('status','Pendente')">Pendentes: <span id="cardPendentes">0</span></div>
      <div class="card" style="background:#10b981" onclick="filtrarRapido('condicao','paga')">Concluídas: <span id="cardConcluidas">0</span></div>
      <div class="card" style="background:#ffbf00; color: #000;" onclick="filtrarRapido('condicao','atenção')">Atenção: <span id="cardAtencao">0</span></div>
      <div class="card" style="background:#ef4444" onclick="filtrarRapido('condicao','vencida')">Vencidas: <span id="cardVencidas">0</span></div>
      <div class="card" style="background:#7c3aed" onclick="navegarLimpo('cadastro-produtos')">Total Produtos: <span id="cardProdutos">0</span></div>
    </div>


    <div id="loaderFiltro" style="display: none; text-align: center; margin-bottom: 15px; color: #0056b3; font-weight: bold; font-family: sans-serif;">
  <div class="spinner" style="border-top-color: #0056b3; display: inline-block; width: 15px; height: 15px;"></div> 
  Atualizando dados, aguarde...
</div>  

    <div class="nav-bar">
    <button onclick="navegarLimpo('cadastro-vendas')" class="btn-nav" style="background:#0056b3; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="fa-solid fa-list-check"></i> Vendas
    </button>

    <button onclick="navegarLimpo('cadastro-produtos')" class="btn-nav" style="background:#0056b3; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="fa-solid fa-box-open"></i> Produtos
    </button>
    
    
    
    
    <button onclick="abrirModalVenda()" class="btn-nav" style="background:#15803d; display: flex; align-items: center; justify-content: center; gap: 8px;">
    <i class="fa-solid fa-cart-plus"></i> Nova Venda
</button>

    <button onclick="abrirNovoProduto()" class="btn-nav" style="background:#15803d; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="fa-solid fa-circle-plus"></i> Novo Produto
    </button>

    <button onclick="window.open('https://catalogo-meirelles.netlify.app/', '_blank')" 
        class="btn-nav" 
        style="background: #10b981; margin-right: 10px;" 
        title="Abrir Catálogo Externo">
  <i class="fa-solid fa-shop"></i> Catálogo
</button>

<button onclick="irParaClientes()" 
  class="btn-nav" 
  style="background:#8b5cf6; display:flex; align-items:center; justify-content:center; gap:8px;">
  <i class="fas fa-users"></i>
  <span>Clientes</span>
</button>

    <button onclick="limparFiltros()" class="btn-nav" style="background:#f59e0b; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="fa-solid fa-trash-can"></i> Limpar filtros
    </button>

    <button onclick="alternarTema()" id="btnTema" class="btn-nav" style="background:#334155; display: flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="fa-solid fa-moon"></i> Dark Mode
    </button>
</div>

    <div class="table-container">
      <table>
        <thead><tr id="cabecalho"></tr><tr id="filtros"></tr></thead>
        <tbody id="corpo"></tbody>
      </table>
    </div>

    <div class="pagination-container">
      <button id="btnAnt" class="btn-pag" onclick="mudarPagina(-1)">Anterior</button>
      <span id="infoPag" style="font-weight: bold; color: #334155;">Página 1</span>
      <button id="btnProx" class="btn-pag" onclick="mudarPagina(1)">Próximo</button>
    </div>
  </div>

  <div id="modalNovoProduto" class="modal">
    <div class="form-box">
        <input type="hidden" id="p_id">

        <h3>Cadastrar Novo Produto</h3>
        
        <input type="text" id="p_cat" placeholder="Categoria">
        <input type="text" id="p_nome" placeholder="Nome do Produto">
        <input type="text" id="p_val" placeholder="Valor (ex: 50.00)">
        
        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <input type="text" id="p_url" placeholder="URL da Imagem ou Upload" style="margin-bottom: 0; flex: 1;">
            
            <input type="file" id="p_file" accept="image/*" style="display: none;" onchange="executarUploadProduto(this)">
            
            <button type="button" onclick="document.getElementById('p_file').click()" 
                    style="background: #38bdf8; border: none; border-radius: 8px; padding: 0 15px; cursor: pointer; color: #0f172a;"
                    title="Upload para Supabase">
                <i class="fas fa-upload"></i>
            </button>
        </div>

        <input type="text" id="p_cor" placeholder="Cor">
        <input type="number" id="p_qtd" placeholder="Quantidade">
        
        <button id="btnGravarProduto" class="btn-gravar" onclick="salvarProduto(event)">Gravar Produto</button>
        <button class="btn-cancelar" onclick="fecharModal('modalNovoProduto')">Cancelar</button>
    </div>
</div>

 <div id="modalPagar" class="modal">
    <div class="confirm-box">
      <div class="confirm-title" style="text-align:center; font-weight:bold; color:#334155; margin-bottom: 15px;">Confirmar Recebimento</div>
      
      <div style="background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center;">
        <span style="color: #64748b; font-size: 14px;">Valor Total da Parcela</span><br>
        <b id="valParcelaExibir" style="font-size: 20px; color: #0f172a;">R$ 0,00</b>
      </div>

      <p style="margin-bottom: 5px; font-weight: bold;">Digite o valor pago:</p>
      
      <div style="position: relative; display: flex; align-items: center;">
        <span style="position: absolute; left: 12px; font-weight: bold; color: #64748b; pointer-events: none;">R$</span>
        <input type="number" id="inputValorPago" step="0.01" 
          style="width: 100%; padding: 12px 12px 12px 38px; font-size: 1.3rem; border: 2px solid #10b981; border-radius: 8px; box-sizing: border-box; font-weight: bold;">
      </div>
      
      <div style="display:flex; margin-top:20px; gap:10px;">
        <button onclick="fecharModal('modalPagar')" class="btn-modal" style="background:#64748b; color:white; flex:1;">Cancelar</button>
        <button id="btnConfirmPagar" class="btn-modal" style="background:#10b981; color:white; flex:1;">Confirmar</button>
      </div>
    </div>
</div>

  <div id="modalExcluir" class="modal">
  <div class="confirm-box">
    <div class="confirm-title" style="color:#ef4444; text-align:center; font-weight:bold; margin-bottom:15px;">Opções de Exclusão</div>
    <p style="font-size:16px; margin-bottom:20px; text-align:center;">Como deseja proceder com a exclusão?</p>
    
    <div style="display:flex; flex-direction:column; gap:10px;">
      <button id="btnExcluirUnica" class="btn-modal" style="background:#f59e0b; color:white;">Excluir APENAS esta parcela</button>
      <button id="btnExcluirTudo" class="btn-modal" style="background:#ef4444; color:white;">Excluir VENDA COMPLETA</button>
      <button class="btn-modal" onclick="fecharModal('modalExcluir')" style="background:#64748b; color:white;">Cancelar</button>
    </div>
  </div>
</div>

<div id="modalExcluirProduto" class="modal">
  <div class="confirm-box">
    <div class="confirm-title" style="color:#ef4444; text-align:center; font-weight:bold; margin-bottom:15px;">Excluir Produto</div>
    <p style="font-size:16px; margin-bottom:20px; text-align:center;">Tem certeza que deseja remover este produto do catálogo?</p>
    
    <div style="display:flex; gap:10px;">
      <button id="btnConfirmarExcluirProd" class="btn-modal" style="background:#ef4444; color:white; flex:1;">Sim, Excluir</button>
      <button class="btn-modal" onclick="fecharModal('modalExcluirProduto')" style="background:#64748b; color:white; flex:1;">Cancelar</button>
    </div>
  </div>
</div>

  <div id="modalResumo" class="modal">
    <div class="form-box">
      <div id="printArea">
        <h3>Resumo Meirelles</h3>
        <div id="resumoConteudo"></div>
      </div>
      <button class="btn-nav" style="background:#10b981; width:100%; margin-top:15px;" onclick="baixarResumo()">Baixar Imagem</button>
      <button class="btn-nav" style="background:#6b7280; width:100%; margin-top:8px;" onclick="fecharModal('modalResumo')">Fechar</button>
    </div>
  </div>

<div id="modalEdicaoProduto" class="modal">
  <div class="form-box">
    <div style="display: flex; align-items: center; gap: 10px; color: #38bdf8; margin-bottom: 20px;">
      <i class="fas fa-pencil-alt"></i>
      <h3 style="margin: 0; color: #38bdf8;">Detalhes / Edição</h3>
    </div>
    
    <input type="hidden" id="editProdId"> 

    <label style="color: #94a3b8; font-size: 12px;">CATEGORIA</label>
    <input type="text" id="editProdCategoria" class="input-travado" readonly>

    <label style="color: #94a3b8; font-size: 12px;">NOME DO PRODUTO</label>
    <input type="text" id="editProdNome" class="input-travado" readonly>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <div>
            <label style="color: #94a3b8; font-size: 12px;">PREÇO (R$)</label>
            <input type="number" id="editProdPreco" class="input-travado" readonly step="0.01">
        </div>
        <div>
            <label style="color: #94a3b8; font-size: 12px;">ESTOQUE ATUAL</label>
            <input type="number" id="editProdEstoque" class="input-travado" readonly>
        </div>
    </div>

    <label style="color: #94a3b8; font-size: 12px;">COR</label>
    <input type="text" id="editProdCor" class="input-travado" readonly>

    <label style="color: #94a3b8; font-size: 12px;">URL DA IMAGEM</label>
    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
        <input type="text" id="editProdUrl" class="input-travado" readonly placeholder="URL da Imagem" style="margin-bottom: 0; flex: 1;">
        
        <input type="file" id="editProdFile" accept="image/*" style="display: none;" onchange="executarUploadProdutoEdicao(this)">
        
        <button type="button" id="btnUploadEdicao" disabled onclick="document.getElementById('editProdFile').click()" 
                style="background: #38bdf8; border: none; border-radius: 8px; padding: 0 15px; cursor: pointer; color: #0f172a; opacity: 0.5;">
            <i class="fas fa-upload"></i>
        </button>
    </div>

    <div id="containerBotoesProd" style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
      <button id="btnHabilitarEdicao" onclick="habilitarCamposProduto()" class="btn-login-glow" style="background: #f59e0b; width: 100%;">
        <i class="fas fa-pencil-alt"></i> EDITAR CAMPOS
      </button>
      
      <button 
  id="btnSalvarEdicao" 
  onclick="confirmarSalvarProduto()" 
  class="btn-gravar" 
  style="background: #10b981; width: 100%;">
    <i class="fas fa-save"></i> SALVAR ALTERAÇÕES
</button>

      <button class="btn-cancelar" onclick="fecharModal('modalEdicaoProduto')" style="width: 100%; margin: 0;">VOLTAR</button>
    </div>
  </div>
</div>


<div id="modalEdicaoCliente" class="modal" style="display:none;">
  <div class="modal-box">
    <h3><i class="fas fa-user-edit"></i> Detalhes do Cliente</h3>

    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 20px;">
        <div id="areaFotoCliente" onclick="document.getElementById('editInputFile').click()" 
             style="cursor: pointer; position: relative; width: 100px; height: 100px; border-radius: 50%; background: #0f172a; border: 2px solid #334155; display: flex; align-items: center; justify-content: center; overflow: hidden; transition: 0.3s;">
            
            <img id="editPreviewFoto" src="" style="display: none; width: 100%; height: 100%; object-fit: cover;">
            <i id="editIconePadrao" class="fas fa-user" style="color: #475569; font-size: 40px;"></i>
            
            <div style="position: absolute; bottom: 0; right: 0; background: #8b5cf6; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #1e293b;">
                <i class="fas fa-camera" style="color: white; font-size: 14px;"></i>
            </div>
        </div>
        <input type="file" id="editInputFile" accept="image/*" style="display: none;" onchange="gerarPreviewEdicao(this)">
        <span style="color: #94a3b8; font-size: 0.7rem; margin-top: 5px;">CLIQUE PARA ALTERAR FOTO</span>
    </div>

    <input type="hidden" id="editClienteId">

    <div class="modal-form-grid">
      <label>Nome Completo:</label>
      <input type="text" id="editClienteNome" class="input-travado" readonly>
      
      <label>CPF/CNPJ:</label>
      <input type="text" id="editClienteCpf" class="input-travado" readonly>
      
      <label>Telefone:</label>
      <input type="text" id="editClienteTelefone" class="input-travado" readonly>
      
      <label>E-mail:</label>
      <input type="email" id="editClienteEmail" class="input-travado" readonly>
      
      <label>CEP:</label>
      <input type="text" id="editClienteCep" class="input-travado" readonly>
      
      <label>Logradouro:</label>
      <input type="text" id="editClienteLogradouro" class="input-travado" readonly>
      
      <label>Número:</label>
      <input type="text" id="editClienteNumero" class="input-travado" readonly>
      
      <label>Bairro:</label>
      <input type="text" id="editClienteBairro" class="input-travado" readonly>
      
      <label>Cidade:</label>
      <input type="text" id="editClienteCidade" class="input-travado" readonly>
    </div>

    <div id="containerBotoesCliente" style="margin-top: 20px; display: flex; gap: 10px;">
        <button onclick="habilitarCamposCliente()" class="btn-nav" style="background: #3b82f6; width: 100%;">Editar Campos</button>
    </div>
    
    <button type="button" onclick="fecharModal('modalEdicaoCliente')" style="background:none; border:none; color:#94a3b8; cursor:pointer; margin-top:15px; font-size:0.8rem; text-decoration:underline; width: 100%;">
        Fechar sem alterar
    </button>
  </div>
</div>


<div id="modalVenda" class="modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; overflow-y: auto; z-index: 1000; padding: 20px 0;">
    
    <div style="max-width: 1100px; margin: 0 auto; background: #1e293b; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); padding: 30px; border: 1px solid #334155;">
        
        <div style="text-align: center; margin-bottom: 30px;">
            <img src="https://i.postimg.cc/N0D8vD8T/crediariomeirelles.jpg" alt="Logo" style="max-height: 100px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
            <h1 style="color: #38bdf8; margin: 0; font-size: 2rem;">CADASTRO DE VENDAS</h1>
            <p style="color: #94a3b8;">Crediário Meirelles - Sistema de Gestão</p>
        </div>

        <form id="formNovaVenda">
            
            <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155;">
                <h3 style="color: #38bdf8; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-user-circle"></i> Dados do Cliente
                </h3>
                
                <div class="venda-layout-grid">
                    <div class="fatia-6">
                        <label>Nome Completo</label>
                        <input type="text" id="nomeCliente" placeholder="Nome do Cliente" required>
                    </div>
                    <div class="fatia-3">
                        <label>CPF</label>
                        <input type="text" id="cpfCliente" placeholder="000.000.000-00" onblur="buscarClientePorCPF(this.value)" required>
                    </div>
                    <div class="fatia-3">
                        <label>WhatsApp</label>
                        <input type="tel" id="telCliente" placeholder="(00) 00000-0000" required>
                    </div>

                    <div class="fatia-4">
                        <label>E-mail (Recibo)</label>
                        <input type="email" id="clienteEmail" placeholder="email@exemplo.com">
                    </div>
                    <div class="fatia-5">
                        <label>Local de Trabalho</label>
                        <input type="text" id="trabalhoCliente" placeholder="Empresa / Cargo">
                    </div>
                    <div class="fatia-3">
                        <label>CEP</label>
                        <input type="text" id="cepCliente" placeholder="00000-000" onblur="buscaCep()">
                    </div>

                    <div class="fatia-5">
                        <label>Logradouro (Rua)</label>
                        <input type="text" id="ruaCliente" placeholder="Ex: Av. Central">
                    </div>
                    
                     <div class="fatia-2">
                        <label>Nº / Compl.</label>
                        <input type="text" id="numComplemento" placeholder="123 / Ap 1">
                    </div>
                    
                    <div class="fatia-3">
                        <label>Bairro</label>
                        <input type="text" id="bairroCliente" placeholder="Bairro">
                    </div>
                    <div class="fatia-2">
                        <label>Cidade</label>
                        <input type="text" id="cidadeCliente" placeholder="Cidade">
                    </div>
                   
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #334155;">
                <h3 style="color: #38bdf8; margin-top: 0; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-shopping-cart"></i> Itens da Venda
                </h3>
                
                <div class="venda-layout-grid">
                    <div class="fatia-7">
                        <label>Escolha o Produto:</label>
                        <select id="selectProduto">
                            <option value="">Carregando produtos...</option>
                        </select>
                    </div>
                    <div class="fatia-2">
                        <label>Qtd:</label>
                        <input type="number" id="qtdProduto" value="1" min="1">
                    </div>
                    <div class="fatia-3">
                        <button type="button" onclick="adicionarAoCarrinho()" class="btn-login-glow" style="margin:0; height: 46px; padding:0; width: 100%;">
                            <i class="fas fa-plus"></i> ADICIONAR
                        </button>
                    </div>
                </div>

                <div style="background: #0f172a; border-radius: 10px; overflow-x: auto; border: 1px solid #334155; margin-top: 20px;">
                    <table style="width: 100%; border-collapse: collapse; color: white; min-width: 600px;">
                        <thead>
                            <tr style="background: #38bdf8; color: #0f172a;">
                                <th style="padding: 12px; text-align: left;">Produto</th>
                                <th style="padding: 12px; text-align: center;">Qtd</th>
                                <th style="padding: 12px; text-align: center;">Unitário</th>
                                <th style="padding: 12px; text-align: center;">Subtotal</th>
                                <th style="padding: 12px; text-align: center;">Ação</th>
                            </tr>
                        </thead>
                        <tbody id="corpoCarrinho"></tbody>
                    </table>
                </div>
            </div>

            <div style="background: rgba(255,255,255,0.03); padding: 20px; border-radius: 12px; border: 1px solid #334155;">
                <div class="venda-layout-grid">
                    <div class="fatia-3">
                        <label>Forma de Pagamento</label>
                        <select id="tipoPagamento" onchange="calcularVendaFinal()">
                            <option value="parcelado">Parcelado (Carnê/Cartão)</option>
                            <option value="vista">À Vista (10% Desc.)</option>
                        </select>
                        <div id="labelDesconto" style="display: none; background: #fbbf24; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-top: 8px; width: fit-content;"></div>
                    </div>

                    <div class="fatia-2">
                        <label>Desc. Vendedor</label>
                        <input type="number" id="descontoVendedor" value="0" step="0.01" oninput="calcularVendaFinal()">
                    </div>

                    <div class="fatia-2">
                        <label>Parc.</label>
                        <select id="numeroParcelas" onchange="calcularVendaFinal()">
                            <option value="1">1x</option><option value="2">2x</option><option value="3">3x</option>
                            <option value="4">4x</option><option value="5">5x</option><option value="6">6x</option>
                            <option value="7">7x</option><option value="8">8x</option><option value="9">9x</option>
                            <option value="10">10x</option><option value="11">11x</option><option value="12">12x</option>
                        </select>
                    </div>

                    <div class="fatia-2">
                        <label>Entrada</label>
                        <input type="number" id="valorEntrada" value="0" oninput="calcularVendaFinal()">
                    </div>

                    <div class="fatia-3">
                        <label>1º Vencimento</label>
                        <input type="date" id="dataVencimento" onchange="calcularVendaFinal()" style="color-scheme: dark;">
                    </div>
                </div>

                <div style="margin-top: 25px; border-top: 1px dashed #334155; padding-top: 20px; text-align: right;">
                    <h2 style="color: white; margin: 0; font-size: 1.8rem; font-weight: bold;">
                        Total Líquido: <span id="valorTotal" style="color: #10b981;">R$ 0,00</span>
                    </h2>
                    <div id="resumoParcelas" style="color: #94a3b8; margin-top: 5px; font-size: 1rem;">1x de R$ 0,00</div>
                </div>

                <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; margin-top: 30px; width: 100%;">
                    <button type="button" id="btnFinalizar" onclick="finalizarVenda()" style="width: 140px; background: #10b981; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-check-circle"></i> SALVAR
                    </button>
                    <button type="button" id="btnComprovante" onclick="imprimirComprovante()" disabled style="width: 140px; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; opacity: 0.5; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-file-invoice"></i> RECIBO
                    </button>
                    <button type="button" onclick="prepararNovaVenda()" style="width: 140px; background: #475569; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px;">
                        <i class="fas fa-plus"></i> NOVA
                    </button>
                    <button type="button" onclick="fecharModal('modalVenda')" style="width: 100px; background: #ef4444; color: white; border: none; padding: 12px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s;">
                        SAIR
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<div id="modalSucesso" class="aviso-sucesso" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999999; align-items: center; justify-content: center; background: rgba(15, 23, 42, 0.9);">
    <div style="text-align: center; background: #ffffff; padding: 40px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2); max-width: 380px; width: 90%; border-top: 8px solid #10b981;">
        <div style="background: #ecfdf5; width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
            <i class="fa-solid fa-check" style="font-size: 40px; color: #10b981;"></i>
        </div>
        <h3 style="color: #1e293b; font-size: 24px; font-weight: 700; margin-bottom: 10px;">Tudo pronto!</h3>
        <p style="color: #64748b; font-size: 16px; line-height: 1.5; margin-bottom: 30px;">O registro foi concluído com sucesso.</p>
        <button onclick="document.getElementById('modalSucesso').style.display='none'" style="background: #10b981; color: white; border: none; padding: 14px 30px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; width: 100%;">OK, ENTENDIDO</button>
    </div>
</div>


<div id="modalZoomFoto" class="modal" onclick="this.style.display='none'" style="display:none; cursor:pointer; background: rgba(0,0,0,0.9); z-index: 9999;">
    <span style="position:absolute; top:20px; right:30px; color:white; font-size:40px; font-weight:bold;">&times;</span>
    <img id="fotoAmpliada" style="max-width:90%; max-height:90%; border-radius:8px; border: 3px solid white; margin: auto; display: block;">
</div>

<div id="modalEsqueci" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:9999; align-items:center; justify-content:center;">
  <div style="background:#1e293b; padding:30px; border-radius:15px; width:90%; max-width:350px; text-align:center; border: 1px solid #334155;">
    <h3 style="color:white; margin-bottom:10px;">Recuperar Acesso</h3>
    <p style="color:#94a3b8; font-size:0.9em; margin-bottom:20px;">Digite seu <b>WhatsApp (com DDD)</b> para receber seus dados de acesso.</p>
    
    <input type="text" id="recuperarTel" placeholder="Ex: DDD+numero" 
       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
       style="width:100%; padding:12px; border-radius:8px; background:#0f172a; border:1px solid #334155; color:white; margin-bottom:20px; outline:none;">
    
    <div style="display:flex; gap:10px;">
      <button onclick="document.getElementById('modalEsqueci').style.display='none'" style="flex:1; padding:10px; border-radius:8px; background:#334155; color:white; border:none; cursor:pointer;">Cancelar</button>
      <button id="btnEnviarRecuperacao" onclick="solicitarRecuperacao()" style="flex:1; padding:10px; border-radius:8px; background:#10b981; color:white; border:none; cursor:pointer; font-weight:bold;">Enviar</button>
    </div>
  </div>
</div>

<div id="modalAviso" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:20000; align-items:center; justify-content:center; backdrop-filter: blur(4px); animation: fadeIn 0.3s ease;">
  <div style="background:#1e293b; padding:30px; border-radius:15px; width:90%; max-width:320px; text-align:center; border: 1px solid #334155; box-shadow: 0 20px 50px rgba(0,0,0,0.6);">
    <div id="avisoIcone" style="font-size: 3.5rem; margin-bottom: 15px;"></div>
    
    <h3 id="avisoTitulo" style="color:white; margin-bottom:10px; font-family: sans-serif; letter-spacing: 0.5px;"></h3>
    <p id="avisoTexto" style="color:#94a3b8; font-size:0.95em; margin-bottom:25px; line-height:1.5;"></p>
    
    <button id="btnModalAviso" onclick="document.getElementById('modalAviso').style.display='none'" 
            style="width:100%; padding:14px; border-radius:8px; background:#10b981; color:white; border:none; cursor:pointer; font-weight:bold; font-size: 1rem; transition: 0.2s;">
      Entendido
    </button>
  </div>
</div>



  
  <script>

  // --- CONFIGURAÇÃO SUPABASE ---
const SB_URL = "https://ixtjoplzakqwfzxpmzwc.supabase.co/rest/v1";
const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4dGpvcGx6YWtxd2Z6eHBtendjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MjEzOTEsImV4cCI6MjA4NTM5NzM5MX0.TIlZg-JSqaMuIirnuN58h3mQTNmHrO-4kShYo94bTqc";
let arquivoTemporarioEdicao = null; 
let idParaExcluir = null;
let urlImagemParaExcluir = null;
let urlOriginalAntesDeEditar = "";
let urlFotoClienteOriginal = "";


// Função padrão para buscar dados no Supabase
async function buscarNoSupabase(endpoint) {
  try {
    const response = await fetch(`${SB_URL}/${endpoint}`, {
      method: 'GET',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      }
    });
    return await response.json();
  } catch (erro) {
    console.error("Erro na requisição:", erro);
    return [];
  }
}

    let dadosPlanilha = [], filtros = {}, abaAtual = '', timerFiltro;
    let paginaAtual = 1;
    const itensPorPagina = 20;
    const colunasSelect = ['id_venda', 'cliente', 'status', 'categoria', 'condicao', 'forma_pagamento', 'parcela'];

    function alternarTema() {
      const isDark = document.body.classList.toggle('dark-theme');
      const btn = document.getElementById('btnTema');
      btn.innerHTML = isDark ? '<i class="fa-solid fa-sun"></i> Light Mode' : '<i class="fa-solid fa-moon"></i> Dark Mode';
      btn.style.background = isDark ? '#f59e0b' : '#334155';
    }

    function togglePass() {
  const senha = document.getElementById('pass'); // ID corrigido para 'pass'
  const icon = document.getElementById('toggleSenha');
  
  if (!senha) return; // Segurança caso o campo não exista

  if (senha.type === 'password') { 
    senha.type = 'text'; 
    icon.classList.replace('fa-eye', 'fa-eye-slash'); 
  } else { 
    senha.type = 'password'; 
    icon.classList.replace('fa-eye-slash', 'fa-eye'); 
  }
}

async function login() {
  const userEl = document.getElementById('user'); 
  const passEl = document.getElementById('pass'); 
  const btn = document.querySelector('#loginBox button');

  const usuario = userEl.value.trim();
  const senha = passEl.value.trim();

  if (!usuario || !senha) {
    mostrarAviso('erro', 'Campos Vazios', 'Preencha utilizador e senha!');
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Entrando...';

  try {
    // Busca o usuário no Supabase
    const response = await fetch(`${SB_URL}/usuarios?login=eq.${usuario}&senha=eq.${senha}&select=*`, {
      method: 'GET',
      headers: { 
        'apikey': SB_KEY, 
        'Authorization': 'Bearer ' + SB_KEY 
      }
    });

    if (!response.ok) throw new Error("Erro na resposta do servidor");

    const dados = await response.json();

    if (dados && dados.length > 0) {
      // --- SALVANDO DADOS DO USUÁRIO ---
      // Salva o objeto completo do usuário (id, login, senha, etc)
      const usuarioLogado = dados[0];
      localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));
      window.usuarioLogado = usuarioLogado; // Backup para editores online
      // ----------------------------------

      // Login bem-sucedido: Troca de tela
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      
      // Atualiza o nome do usuário na interface
      const display = document.getElementById('nomeDisplay');
      if (display) display.textContent = usuario.toUpperCase();
      
      // Carrega os dados iniciais
      await Promise.allSettled([
        carregarProdutosSupabase(),
        mostrarLista('cadastro-vendas')
      ]);

      console.log("Sistema carregado com sucesso para:", usuario);

    } else {
      mostrarAviso('erro', 'Acesso Negado', 'Utilizador ou senha incorretos!');
    }

  } catch (err) {
    console.error("Erro no processo de login:", err);
    
    if (!window.navigator.onLine) {
      mostrarAviso('erro', 'Sem Internet', 'Verifique sua conexão para entrar no sistema.');
    } else {
      console.log("Instabilidade momentânea detectada.");
    }

  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = 'Entrar';
    }
  }
}

    
    function logout() { 
  // Esconde o sistema e mostra o login
  document.getElementById('dashboard').style.display = 'none'; 
  document.getElementById('loginScreen').style.display = 'flex'; 

  // RESET DO BOTÃO DE LOGIN
  const btn = document.querySelector('.btn-login-glow');
  btn.disabled = false;
  btn.innerHTML = 'ENTRAR'; // Remove a animação e volta o texto original

  // Opcional: Limpar os campos de usuário e senha para o próximo login
  document.getElementById('senha').value = '';
}


   async function navegarLimpo(aba) {
  // 1. Liga o carregando
  document.getElementById('loaderFiltro').style.display = 'block';
  
  filtros = {}; 
  paginaAtual = 1; 

  // 2. SE FOR VENDAS, CARREGA OS PRODUTOS NO SELECT
  if (aba === 'cadastro-vendas') {
    await carregarProdutos(); // Chama aquela função completa que você postou
  }

  // 3. Mostra a tela
  mostrarLista(aba);
}

async function mostrarLista(aba) {
  abaAtual = aba;
  // 1. Liga o carregando
  document.getElementById('loaderFiltro').style.display = 'block';

  // RESET de filtros ao trocar de aba
  filtros = {}; 
  paginaAtual = 1;

  let tabela;

if (aba === 'cadastro-produtos') tabela = 'produtos';
else if (aba === 'cadastro-clientes') tabela = 'clientes';
else tabela = 'vendas';

  try {
    // 2. Busca os dados no Supabase
    const response = await fetch(`${SB_URL}/${tabela}?select=*`, {
      method: 'GET',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      }
    });

    const resSupabase = await response.json();

    // 3. Organização dos Dados
    if (!resSupabase || resSupabase.length === 0) {
      dadosPlanilha = []; 
    } else {
      dadosPlanilha = resSupabase; 
    }

    // --- O PULO DO GATO ESTÁ AQUI ---
    // Se a aba for de vendas, além de desenhar a tabela, 
    // precisamos popular o select de produtos do formulário.
    if (aba === 'cadastro-vendas') {
      await carregarProdutos(); // Carrega os nomes no select id="selectProduto"
    }

    // 4. Atualiza a interface
    if (typeof atualizarCards === 'function') await atualizarCards(); 
    desenharTabela();

  } catch (error) {
    console.error("Erro ao carregar dados do Supabase:", error);
    if (typeof mostrarAviso === 'function') {
        mostrarAviso('erro', 'Erro de Conexão', 'Não foi possível carregar os dados.');
    }
  } finally {
    document.getElementById('loaderFiltro').style.display = 'none';
  }
}

    function aplicarFiltroDinamico(coluna, valor) {
  document.getElementById('loaderFiltro').style.display = 'block';

  clearTimeout(timerFiltro);
  
  timerFiltro = setTimeout(() => { 
    filtros[coluna] = valor; // 'coluna' agora é o nome (ex: 'cliente')
    paginaAtual = 1; 
    desenharTabela(); 
    
    document.getElementById('loaderFiltro').style.display = 'none';
  },4000); // Reduzi para 500ms para ficar mais rápido, 4s é muito tempo.
}

    function mudarPagina(valor) {
      paginaAtual += valor; desenharTabela();
    }

async function desenharTabela() {
  const corpo = document.getElementById('corpo'),
        cab = document.getElementById('cabecalho'),
        fil = document.getElementById('filtros');

  if (!corpo || !cab || !fil) return;

  vendasCarregadas = dadosPlanilha;

  // 1. DEFINIÇÃO DINÂMICA DE COLUNAS
  let colunas = [];

  if (abaAtual === 'cadastro-produtos') {
    colunas = ['categoria', 'nome', 'preco', 'imagem_url']; 
  } 
  else if (abaAtual === 'cadastro-clientes') {
    // ADICIONADO: 'foto_url' como a primeira coluna de dados dos clientes
    colunas = [
      'foto_url',
      'cliente_nome',
      'cpf_cnpj',
      'telefone',
      'email',
      'cep',
      'logradouro',
      'numero',
      'bairro',
      'cidade'
    ];
  } 
  else {
    colunas = [
      'id_venda', 'cliente', 'cpf', 'telefone', 'endereco', 'trabalho', 'produto', 
      'forma_pagamento', 'valor_total', 'entrada', 'desconto_vendedor', 
      'parcela', 'data_vencimento', 'valor_parcela', 'valor_pago', 'status'
    ];
  }

  // Limpeza inicial
  cab.innerHTML = '<th class="col-resumo">🔎</th>';
  fil.innerHTML = '<th class="col-resumo"></th>';
  corpo.innerHTML = '';

  // 2. Criar Cabeçalho e Filtros
  colunas.forEach((title) => {
    // Se for a coluna de foto, o cabeçalho fica mais curto
    const labelHeader = title === 'foto_url' ? 'FOTO' : title.replace('_', ' ').toUpperCase();
    cab.innerHTML += `<th>${labelHeader}</th>`;
    
    let thF = document.createElement('th');
    const colunasSelect = ['id_venda', 'cliente', 'cpf', 'parcela', 'status', 'forma_pagamento', 'trabalho', 'produto', 'categoria'];

    if (title === 'foto_url') {
        thF.innerHTML = ''; // Sem filtro para a foto
    } else if (colunasSelect.includes(title) && dadosPlanilha.length > 0) {
        let opcoes = [...new Set(dadosPlanilha.map(item => item[title]))].filter(v => v).sort();
        let htmlSel = `<select onchange="aplicarFiltroDinamico('${title}', this.value, event)" style="width:100%; border:1px solid #ddd; border-radius:4px; font-size:0.75rem;">
                        <option value="">Filtrar...</option>`;
        opcoes.forEach(opt => {
            htmlSel += `<option value="${opt}" ${filtros[title] == opt ? 'selected' : ''}>${String(opt).toUpperCase()}</option>`;
        });
        htmlSel += `</select>`;
        thF.innerHTML = htmlSel;
    } else {
        thF.innerHTML = `<input oninput="aplicarFiltroDinamico('${title}', this.value, event)" value="${filtros[title] || ''}" placeholder="Filtrar..." style="width:100%;">`;
    }
    fil.appendChild(thF);
  });

  if (abaAtual === 'cadastro-vendas') {
    cab.innerHTML += `<th>CONDIÇÃO</th>`;
    let thFCond = document.createElement('th');
    thFCond.innerHTML = `
      <select onchange="aplicarFiltroDinamico('condicao', this.value, event)" style="width:100%; border:1px solid #ddd; border-radius:4px; font-size:0.75rem;">
        <option value="">Filtrar...</option>
        <option value="PAGO" ${filtros['condicao'] == 'PAGO' ? 'selected' : ''}>PAGO</option>
        <option value="PENDENTE" ${filtros['condicao'] == 'PENDENTE' ? 'selected' : ''}>PENDENTE</option>
        <option value="ATENÇÃO" ${filtros['condicao'] == 'ATENÇÃO' ? 'selected' : ''}>ATENÇÃO</option>
        <option value="VENCIDO" ${filtros['condicao'] == 'VENCIDO' ? 'selected' : ''}>VENCIDO</option>
      </select>
    `;
    fil.appendChild(thFCond);
  }
  cab.innerHTML += '<th>AÇÕES</th>';
  let thAcoes = document.createElement('th');
  fil.appendChild(thAcoes);

  // 3. Filtros (Mantidos exatamente como os originais)
  let filtrados = dadosPlanilha.filter(item => {
    let passaNormal = Object.keys(filtros).every(k => {
      if (!filtros[k] || k === "especial" || k === "condicao") return true;
      return String(item[k] || "").toLowerCase().includes(String(filtros[k]).toLowerCase());
    });
    const statusLimpo = String(item.status || "").toUpperCase();
    const resolvido = statusLimpo === "PAGO" || statusLimpo === "PARCIAL" || statusLimpo.includes("CONCLU");
    const hoje = new Date(); hoje.setHours(0,0,0,0);
    const v = item.data_vencimento ? new Date(item.data_vencimento + 'T00:00:00') : null;
    let passaCondicao = true;
    if (filtros["condicao"] && abaAtual === 'cadastro-vendas') {
      const f = filtros["condicao"];
      if (f === "PAGO") passaCondicao = resolvido;
      else if (f === "PENDENTE") passaCondicao = !resolvido;
      else if (f === "VENCIDO") passaCondicao = !resolvido && v && v < hoje;
      else if (f === "ATENÇÃO") {
        let lim = new Date(); lim.setDate(hoje.getDate() + 5);
        passaCondicao = !resolvido && v && v >= hoje && v <= lim;
      }
    }
    let passaEspecial = true;
    if (filtros["especial"] && abaAtual === 'cadastro-vendas') {
      const e = filtros["especial"];
      if (e === 'paga') passaEspecial = resolvido;
      else if (e === 'pendente') passaEspecial = !resolvido;
      else if (v && !resolvido) {
        if (e === 'vencida') passaEspecial = v < hoje;
        else if (e === 'atenção') {
          let lim = new Date(); lim.setDate(hoje.getDate() + 5);
          passaEspecial = v >= hoje && v <= lim;
        }
      } else { passaEspecial = false; }
    }
    return passaNormal && passaCondicao && passaEspecial;
  });

  // 4. Paginação
  const totalPaginas = Math.ceil(filtrados.length / itensPorPagina);
  const itensPagina = filtrados.slice((paginaAtual - 1) * itensPorPagina, paginaAtual * itensPorPagina);
  if (document.getElementById('infoPag')) document.getElementById('infoPag').textContent = `Página ${paginaAtual} de ${totalPaginas || 1}`;
  if (document.getElementById('btnAnt')) document.getElementById('btnAnt').disabled = paginaAtual === 1;
  if (document.getElementById('btnProx')) document.getElementById('btnProx').disabled = paginaAtual >= totalPaginas || totalPaginas === 0;

  // 5. Renderização das Linhas
  itensPagina.forEach((item) => {
    const tr = document.createElement('tr');
    
    // --- COLUNA DE RESUMO / EDIÇÃO (A PRIMEIRA) ---
    const tdAcaoInicial = document.createElement('td');
    tdAcaoInicial.className = "col-resumo";
    
    const btnAcao = document.createElement('button');
    btnAcao.type = "button"; 
    btnAcao.style.cssText = "background:none; border:none; cursor:pointer; padding:8px; display:inline-block;";

    let iconeClasse = 'fa-magnifying-glass';
    let corIcone = '#0056b3';

    if (abaAtual === 'cadastro-produtos') {
      iconeClasse = 'fa-pencil-alt';
      corIcone = '#f59e0b';
    } else if (abaAtual === 'cadastro-clientes') {
      iconeClasse = 'fa-pencil-alt';
      corIcone = '#8b5cf6';
    }

    btnAcao.innerHTML = `<i class="fa-solid ${iconeClasse}" style="color:${corIcone}; pointer-events:none;"></i>`;

    btnAcao.onclick = (e) => {
      e.preventDefault();
      e.stopPropagation();
      const idAtual = item.id || item.id_venda;
      if (abaAtual === 'cadastro-produtos') {
        abrirEdicaoProduto(idAtual);
      } else if (abaAtual === 'cadastro-clientes') {
        if (typeof abrirEdicaoCliente === 'function') {
           abrirEdicaoCliente(idAtual);
        }
      } else {
        abrirResumo(idAtual);
      }
    };

    tdAcaoInicial.appendChild(btnAcao);
    tr.appendChild(tdAcaoInicial);

    // --- COLUNAS DE DADOS (Inclusão da Lógica de Foto) ---
    colunas.forEach(col => {
      let valor = item[col] || "";
      let cl = "";

      // NOVA FUNÇÃO PARA RENDERIZAR FOTO DO CLIENTE
   if (col === 'foto_url') {
  const idAtual = item.id;
  const urlFoto = valor || "";

  valor = `
    <div class="foto-container-tabela" style="position: relative; width: 40px; height: 40px; margin: auto;">
      <img src="${urlFoto || 'https://via.placeholder.com/40'}" 
           onclick="ampliarFoto('${urlFoto}')"
           id="img-tabela-${idAtual}"
           title="Clique no centro para ampliar"
           style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #38bdf8; cursor: zoom-in; display: block;">
      
      <div onclick="document.getElementById('input-foto-${idAtual}').click()" 
           title="Trocar foto"
           style="position: absolute; bottom: -2px; right: -2px; background: #38bdf8; color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid #0f172a; box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10;">
        <i class="fas fa-camera" style="font-size: 9px;"></i>
      </div>

      <input type="file" id="input-foto-${idAtual}" style="display:none" accept="image/*" 
             onchange="atualizarFotoDireto('${idAtual}', this)">
    </div>
  `;
}
      else if (col === 'imagem_url') {
        valor = (valor && String(valor).startsWith('http')) 
          ? `<a href="${valor}" target="_blank" style="color:#3b82f6; text-decoration:none;"><i class="fa-solid fa-image"></i> Ver Foto</a>` 
          : `<span style="color:#94a3b8; font-size:0.7rem;">Sem foto</span>`;
      }
      else if (col === 'endereco') {
        valor = `${valor}${item.numero ? `, ${item.numero}` : ""}${item.bairro ? ` - ${item.bairro}` : ""}`;
      }
      else if (col.includes('valor') || col.includes('total') || col === 'preco' || col === 'entrada') {
        let num = parseFloat(valor) || 0;
        valor = (col === 'valor_pago' && num === 0) ? "" : num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        cl = (col === 'valor_pago') ? 'texto-verde-negrito' : 'col-valor';
      }
      else if (col.includes('data') && valor) {
        try { valor = new Date(valor + 'T00:00:00').toLocaleDateString('pt-BR'); } catch(e) { valor = item[col]; }
      }

      const td = document.createElement('td');
      td.className = cl;
      td.innerHTML = valor;
      tr.appendChild(td);
    });

    // 6. Condição (Cadastro de Vendas)
    if (abaAtual === 'cadastro-vendas') {
      const tdCond = document.createElement('td');
      const status = String(item.status || "").toUpperCase();
      const jaResolvido = status === "PAGO" || status === "PARCIAL" || status.includes("CONCLU");
      let label = "PENDENTE", bg = "#64748b";
      if (jaResolvido) { label = "PAGO"; bg = "#10b981"; } 
      else {
        const hoje = new Date(); hoje.setHours(0,0,0,0);
        const v = new Date(item.data_vencimento + 'T00:00:00');
        if (v < hoje) { label = "VENCIDO"; bg = "#ef4444"; }
        else if (v <= new Date().setDate(new Date().getDate() + 5)) { label = "ATENÇÃO"; bg = "#f59e0b"; }
      }
      tdCond.innerHTML = `<span style="background:${bg}; color:white; padding:3px 8px; border-radius:12px; font-size:10px; font-weight:bold; display:inline-block; min-width:70px; text-align:center;">${label}</span>`;
      tr.appendChild(tdCond);
    }

    // --- 7. AÇÕES (Lado Direito da Tabela) ---
    const tdA = document.createElement('td');
    tdA.style.textAlign = "center";

    switch (abaAtual) {
        case 'cadastro-vendas':
    // Buscamos a mesma lógica usada na coluna CONDIÇÃO logo acima
    const statusLimpo = String(item.status || "").toUpperCase();
    const condicaoPaga = statusLimpo === "PAGO" || statusLimpo === "PARCIAL" || statusLimpo.includes("CONCLU");

    tdA.innerHTML = `
        ${condicaoPaga 
            ? `<button disabled class="btn-nav" style="background:#475569; color:#94a3b8; cursor:not-allowed; opacity:0.6;" title="Esta venda já consta como Paga">
                <i class="fa-solid fa-check-double"></i>
               </button>` 
            : `<button onclick="abrirPagar('${item.id}')" class="btn-nav" style="background:#10b981;" title="Marcar como Pago">
                <i class="fa-solid fa-check"></i>
               </button>`
        }
        <button onclick="abrirExcluir('${item.id}')" class="btn-nav" style="background:#ef4444; margin-left:5px;" title="Excluir Venda">
            <i class="fa-solid fa-trash-can"></i>
        </button>
    `;
    break;
        case 'cadastro-clientes':
            tdA.innerHTML = `
                <button onclick="confirmarExclusaoCliente('${item.id}', '${item.cliente_nome}')" class="btn-nav" style="background:#ef4444;">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            `;
            break;
        case 'cadastro-produtos':
            tdA.innerHTML = `
                <button onclick="abrirExcluir('${item.id}')" class="btn-nav" style="background:#ef4444;">✘</button>
            `;
            break;
        default:
            tdA.innerHTML = `<button onclick="abrirExcluir('${item.id}')" class="btn-nav" style="background:#ef4444;">✘</button>`;
    }

    tr.appendChild(tdA);
    corpo.appendChild(tr);
  });
}

async function salvarProduto(event) {
  if (event) event.preventDefault();
  
  const btn = document.getElementById('btnGravarProduto');
  const inputUrl = document.getElementById('p_url'); 
  let urlFinalParaBanco = inputUrl.value; 

  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GRAVANDO...';
  }

  try {
    // 1. FAZ O UPLOAD DA IMAGEM SE HOUVER
    if (arquivoTemporarioEdicao) {
      const baseURL = SB_URL.replace('/rest/v1', '');
      const extensao = arquivoTemporarioEdicao.name.split('.').pop();
      const nomeArquivo = `prod_novo_${Date.now()}.${extensao}`;

      const uploadResponse = await fetch(`${baseURL}/storage/v1/object/produtos/${nomeArquivo}`, {
        method: 'POST',
        headers: {
          'apikey': SB_KEY,
          'Authorization': `Bearer ${SB_KEY}`,
          'Content-Type': arquivoTemporarioEdicao.type
        },
        body: arquivoTemporarioEdicao
      });

      if (uploadResponse.ok) {
        urlFinalParaBanco = `${baseURL}/storage/v1/object/public/produtos/${nomeArquivo}`;
        
        // Feedback visual: mostra a URL gerada no campo antes de salvar o banco
        inputUrl.value = urlFinalParaBanco;
        inputUrl.style.backgroundColor = "#dcfce7";
      } else {
        throw new Error("Erro ao subir imagem para o servidor.");
      }
    }

    // 2. MONTA OS DADOS (Nota: Supabase aceita objeto direto ou array)
    const novoProduto = {
      categoria:  document.getElementById('p_cat').value,
      nome:       document.getElementById('p_nome').value,
      preco:      parseFloat(document.getElementById('p_val').value.replace(',', '.')) || 0,
      imagem_url: urlFinalParaBanco,
      cor:        document.getElementById('p_cor').value,
      estoque:    parseInt(document.getElementById('p_qtd').value) || 0
    };

    // 3. ENVIA PARA O SUPABASE
    const response = await fetch(`${SB_URL}/produtos`, {
      method: 'POST',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(novoProduto) // Enviando objeto direto
    });

    if (response.ok) {
      // --- AQUI ACONTECE A ATUALIZAÇÃO AUTOMÁTICA ---
      // 4. ATUALIZA A TABELA NO FUNDO ANTES DE FECHAR
      if (typeof mostrarLista === 'function') {
        console.log("Atualizando lista de produtos...");
        await mostrarLista('cadastro-produtos'); 
      }

      alert("✅ Produto cadastrado com sucesso!");
      
      // 5. LIMPEZA E FECHAMENTO
      fecharModal('modalNovoProduto');
      
      arquivoTemporarioEdicao = null;
      inputUrl.style.backgroundColor = "";
      
      // Reseta os campos do formulário
      const form = document.querySelector('#modalNovoProduto .form-box');
      if (form) form.querySelectorAll('input, select').forEach(i => i.value = "");
    }

  } catch (err) {
    alert("Erro: " + err.message);
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = "Gravar Produto";
    }
  }
}

    function abrirNovoProduto() {
    const ids = ['p_id', 'p_cat', 'p_nome', 'p_val', 'p_url', 'p_cor', 'p_qtd'];
    ids.forEach(id => {
        const campo = document.getElementById(id);
        if (campo) campo.value = "";
    });

    const preview = document.getElementById('imgPreview');
    if (preview) preview.style.display = 'none';

    // RESET DO BOTÃO (Caso tenha ficado travado com spinner)
    const btn = document.getElementById('btnGravarProduto');
    if (btn) {
        btn.disabled = false;
        btn.innerHTML = 'Gravar Produto';
    }

    document.getElementById('modalNovoProduto').style.display = 'flex';
}
  
    function limparFiltros() { 
  filtros = {}; 
  paginaAtual = 1; 
  desenharTabela(); 
  // Garante que o aviso de carregando suma imediatamente ao limpar
  document.getElementById('loaderFiltro').style.display = 'none';
}
    
async function filtrarRapido(c, v) { 
    document.getElementById('loaderFiltro').style.display = 'block';

    // 1. Garante que estamos na aba de vendas
    if (abaAtual !== 'cadastro-vendas') {
        await mostrarLista('cadastro-vendas'); 
    }

    // 2. Aplicamos o filtro na variável global 'filtros'
    // Limpamos outros filtros para o card ser prioridade
    filtros = {}; 

    if (c === 'condicao') {
        // Guardamos o valor (vencida, atenção, paga) para a desenharTabela usar
        filtros["especial"] = v.toLowerCase(); 
    } else {
        filtros[c] = v;
    }

    paginaAtual = 1; 
    
    // 3. O SEGREDO: A desenharTabela precisa ler o filtros["especial"]
    desenharTabela();
    
    document.getElementById('loaderFiltro').style.display = 'none';
}

async function atualizarCards() {
  if (!dadosPlanilha || dadosPlanilha.length === 0) {
    const ids = ['cardVendas', 'cardPendentes', 'cardConcluidas', 'cardVencidas', 'cardAtencao'];
    ids.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = "0"; });
    return;
  }

  if (abaAtual === 'cadastro-vendas') {
    const idsUnicos = [...new Set(dadosPlanilha.map(x => x.id_venda))].filter(id => id);
    if(document.getElementById('cardVendas')) document.getElementById('cardVendas').textContent = idsUnicos.length;

    let contadores = { pendentes: 0, pagas: 0, vencidas: 0, atencao: 0 };
    
    const hoje = new Date(); 
    hoje.setHours(0, 0, 0, 0);

    dadosPlanilha.forEach(item => {
      const status = String(item.status || "").toUpperCase();
      const jaResolvido = status === "PAGO" || status === "PARCIAL" || status.includes("CONCLU");
      
      if (jaResolvido) {
        contadores.pagas++;
      } else {
        // --- SE NÃO ESTÁ PAGA, ELA É CONSIDERADA PENDENTE (TOTAL GERAL) ---
        contadores.pendentes++; 

        // Agora classificamos para os cards específicos de alerta
        if (item.data_vencimento) {
          const v = new Date(item.data_vencimento + 'T00:00:00');
          v.setHours(0,0,0,0);

          if (v < hoje) {
            contadores.vencidas++; // Também conta como Vencida
          } else {
            let lim = new Date(); 
            lim.setDate(hoje.getDate() + 5);
            lim.setHours(23, 59, 59, 999);

            if (v <= lim) {
              contadores.atencao++; // Também conta como Atenção
            }
          }
        }
      }
    });

    // Atualiza os elementos na tela
    if(document.getElementById('cardPendentes'))  document.getElementById('cardPendentes').textContent = contadores.pendentes;
    if(document.getElementById('cardConcluidas')) document.getElementById('cardConcluidas').textContent = contadores.pagas;
    if(document.getElementById('cardVencidas'))   document.getElementById('cardVencidas').textContent = contadores.vencidas;
    if(document.getElementById('cardAtencao'))    document.getElementById('cardAtencao').textContent = contadores.atencao;
  }
  
  // Card de Produtos
  try {
    const res = await fetch(`${SB_URL}/produtos?select=id`, {
      method: 'GET',
      headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY }
    });
    const produtos = await res.json();
    if (produtos && document.getElementById('cardProdutos')) {
      document.getElementById('cardProdutos').textContent = produtos.length;
    }
  } catch (err) { console.error("Erro produtos:", err); }
}



async function abrirPagar(id) {
  const venda = dadosPlanilha.find(v => v.id === id);
  if (!venda) return alert("Venda não localizada!");

  // Limpeza do valor da parcela atual
  let vBruto = String(venda.valor_parcela || "0").replace(/[R$\s]/g, '');
  if (vBruto.includes(',') && vBruto.includes('.')) vBruto = vBruto.replace(/\./g, '');
  vBruto = vBruto.replace(',', '.');
  const valorOriginal = Math.round(parseFloat(vBruto) * 100) / 100;

  const input = document.getElementById('inputValorPago');
  const btnConfirm = document.getElementById('btnConfirmPagar');

  btnConfirm.disabled = false;
  btnConfirm.innerHTML = "Confirmar";
  document.getElementById('valParcelaExibir').textContent = valorOriginal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  input.value = valorOriginal.toFixed(2);
  document.getElementById('modalPagar').style.display = 'flex';

  setTimeout(() => { input.focus(); input.select(); }, 300);

  btnConfirm.onclick = async () => {
    const vDigitado = parseFloat(input.value.replace(',', '.'));
    if (isNaN(vDigitado) || vDigitado <= 0) return alert("Digite um valor válido!");
    
    btnConfirm.disabled = true;
    btnConfirm.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processando...';

    try {
      const residuo = Math.round((valorOriginal - vDigitado) * 100) / 100;
      const hoje = new Date().toISOString().split('T')[0];

      const novoStatus = (vDigitado < valorOriginal) ? 'PARCIAL' : 'PAGO';

      // 1. ATUALIZAR PARCELA ATUAL
      const urlUpdate = `${SB_URL}/vendas?id=eq.${id}`;
      const resAtual = await fetch(urlUpdate, {
        method: 'PATCH',
        headers: {
          'apikey': SB_KEY,
          'Authorization': 'Bearer ' + SB_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          status: novoStatus,
          valor_pago: vDigitado,
          data_pagamento: hoje
        })
      });

      if (!resAtual.ok) throw new Error("Erro ao atualizar parcela.");
      
      enviarConfirmacaoParaN8N(venda, vDigitado, valorOriginal);

      // 2. LÓGICA DE RESÍDUO (CORRIGIDA PARA NÃO MULTIPLICAR POR 100)
      if (residuo !== 0) {
        let proxParcelaNum = "";
        if (venda.parcela && venda.parcela.includes('/')) {
          let partes = venda.parcela.split('/');
          let atual = parseInt(partes[0]);
          let total = parseInt(partes[1]);
          if (atual < total) proxParcelaNum = (atual + 1) + "/" + total;
        }

        let proximaVenda = null;
        if (proxParcelaNum) {
          proximaVenda = dadosPlanilha.find(v => 
            v.id_venda === venda.id_venda && 
            v.parcela === proxParcelaNum && 
            !(v.status || "").toUpperCase().includes('PAG')
          );
        }

        if (proximaVenda) {
          // --- LIMPEZA RIGOROSA DO VALOR DA PRÓXIMA PARCELA ---
          let vProxTexto = String(proximaVenda.valor_parcela || "0").replace(/[R$\s]/g, '');
          
          // Se tiver ponto de milhar (ex: 1.000,00), remove o ponto antes de trocar a vírgula
          if (vProxTexto.includes('.') && vProxTexto.includes(',')) {
            vProxTexto = vProxTexto.replace(/\./g, '');
          }
          let vProxLimpo = vProxTexto.replace(',', '.');
          let vProxNumerico = parseFloat(vProxLimpo) || 0;

          const novoValorSoma = Math.round((vProxNumerico + residuo) * 100) / 100;

          await fetch(`${SB_URL}/vendas?id=eq.${proximaVenda.id}`, {
            method: 'PATCH',
            headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify({ valor_parcela: novoValorSoma })
          });
        } else if (residuo > 0) {
          // B: Criar parcela PF
          const dVenc = new Date(venda.data_vencimento + 'T12:00:00');
          dVenc.setMonth(dVenc.getMonth() + 1);
          
          const { id: oldId, ...dadosParaNovo } = venda; 
          const novaPF = {
            ...dadosParaNovo,
            parcela: "PF",
            valor_parcela: residuo,
            valor_pago: 0,
            status: "Pendente",
            data_vencimento: dVenc.toISOString().split('T')[0],
            data_pagamento: null
          };

          await fetch(`${SB_URL}/vendas`, {
            method: 'POST',
            headers: { 'apikey': SB_KEY, 'Authorization': 'Bearer ' + SB_KEY, 'Content-Type': 'application/json' },
            body: JSON.stringify(novaPF)
          });
        }
      }

      fecharModal('modalPagar');
      if (typeof buscarDados === 'function') await buscarDados(); 
      else await mostrarLista(abaAtual);

    } catch (erro) {
      alert("Falha no processamento: " + erro.message);
      btnConfirm.disabled = false;
      btnConfirm.innerHTML = "Confirmar";
    }
  };
}


function enviarConfirmacaoParaN8N(vendaObjeto, valorRecebido, valorOriginal) {
  const webhookURL = "https://n8n.vps6993.panel.icontainer.net/webhook/crm-vendaconfirmada";

  // Regra da parcela parcial
  const tipoPagamento = (parseFloat(valorRecebido) < parseFloat(valorOriginal) - 0.01) ? "PARCIAL" : "TOTAL";

  const dados = {
    cliente: vendaObjeto.cliente,
    telefone: vendaObjeto.telefone || "",
    produto: vendaObjeto.produto || "",
    parcela: vendaObjeto.parcela || "",
    valor_pago: valorRecebido,
    valor_original: valorOriginal,
    tipo: tipoPagamento, 
    data_pagamento: new Date().toLocaleDateString('pt-BR'),
    status: 'paga'
  };

  fetch(webhookURL, { 
    method: 'POST', 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dados) 
  })
  .then(() => console.log("✅ n8n enviado com sucesso: " + tipoPagamento))
  .catch(err => console.error("❌ Erro ao disparar n8n:", err));
}

function abrirResumo(idVendaUnico) {
  try {
    console.log("Tentando abrir resumo da venda:", idVendaUnico);

    // 1. Verifica se a gaveta de vendas existe
    if (!vendasCarregadas || vendasCarregadas.length === 0) {
        alert("Aguarde o carregamento das vendas...");
        return;
    }

    // 2. Localiza a venda
    const venda = vendasCarregadas.find(v => v.id_venda === idVendaUnico);

    if (!venda) {
      console.error("Venda não encontrada no cache local:", idVendaUnico);
      alert("Venda não encontrada! Tente atualizar a página.");
      return;
    }

    let html = '';

    const camposTraduzidos = {
      cliente: "CLIENTE",
      cpf: "CPF",
      telefone: "TELEFONE",
      produto: "PRODUTO(S)",
      valor_total: "VALOR TOTAL",
      parcela: "PARCELA",
      valor_parcela: "VALOR DA PARCELA",
      data_vencimento: "VENCIMENTO",
      forma_pagamento: "FORMA DE PAGAMENTO",
      status: "STATUS",
      trabalho: "TRABALHO"
    };

    Object.keys(camposTraduzidos).forEach(chave => {
      let valor = venda[chave] || '---';
      let titulo = camposTraduzidos[chave];

      if (chave.includes('valor') || chave.includes('total')) {
        let num = parseFloat(valor) || 0;
        valor = num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
      }

      if (chave.includes('data') && valor !== '---') {
        let p = valor.split('-'); 
        if (p.length === 3) valor = `${p[2]}/${p[1]}/${p[0]}`;
      }

      html += `
        <div style="margin-bottom: 8px; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px; text-align: left;">
          <b style="color: #64748b; font-size: 0.75rem; text-transform: uppercase;">${titulo}:</b><br>
          <span style="color: #1e293b; font-weight: 600; font-size: 0.9rem;">${valor}</span>
        </div>`;
    });

    const corpoResumo = document.getElementById('resumoConteudo');
    const modal = document.getElementById('modalResumo');

    if (corpoResumo && modal) {
      corpoResumo.innerHTML = html;
      modal.style.display = 'flex';
    } else {
      console.error("Elementos modalResumo ou resumoConteudo não existem no HTML.");
    }

  } catch (erro) {
    console.error("Erro crítico ao abrir resumo:", erro);
  }
}




async function finalizarVenda() {
  const btn = document.getElementById('btnFinalizar');
  const btnComp = document.getElementById('btnComprovante'); 
  
  if (btn) {
    btn.disabled = true;
    btn.style.setProperty('background', '#64748b', 'important');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
  }

  try {
    // CAPTURA DOS DADOS DO HTML
    const nome = document.getElementById('nomeCliente').value.trim();
    const cpf = document.getElementById('cpfCliente').value.replace(/\D/g, '');
    const tel = document.getElementById('telCliente')?.value || "";
    const emailValor = document.getElementById('clienteEmail')?.value || ""; 
    const cep = document.getElementById('cepCliente')?.value || "";    
    const rua = document.getElementById('ruaCliente')?.value || "";
    const bairro = document.getElementById('bairroCliente')?.value || "";
    const cidade = document.getElementById('cidadeCliente')?.value || "";
    const num = document.getElementById('numComplemento')?.value || ""; 
    
    // Monta o endereço para a tabela VENDAS e n8n
    const enderecoCompleto = `${rua}, ${num} - ${bairro}, ${cidade}`;

    if (itensNoCarrinho.length === 0) {
      alert("O carrinho está vazio!");
      if (btn) {
        btn.disabled = false;
        btn.style.setProperty('background', '#10b981', 'important');
        btn.innerHTML = '<i class="fas fa-check-circle"></i> SALVAR';
      }
      return;
    }

    // Formatação do Produto para o n8n (Ex: R$ 400.00 Espelho -x 1 = R$ 400.00)
    const listaProdutosTxt = itensNoCarrinho.map(item => 
      `R$ ${item.preco.toFixed(2)} ${item.nome} -x ${item.qtd} = R$ ${item.subtotal.toFixed(2)}`
    ).join(' + ');

    const bruto = itensNoCarrinho.reduce((acc, item) => acc + item.subtotal, 0);
    const entrada = parseFloat(document.getElementById('valorEntrada')?.value) || 0;
    const descVendedor = parseFloat(document.getElementById('descontoVendedor')?.value) || 0; 
    const formaPagamento = document.getElementById('tipoPagamento')?.value || "";
    const trabalho = document.getElementById('trabalhoVenda')?.value || "Não informado"; 

    const descontoSistema = (formaPagamento === 'vista') ? (bruto * 0.10) : 0;
    const descontoTotal = descontoSistema + descVendedor;
    const valorLiquidoVenda = bruto - descontoTotal;
    const saldoDevedor = valorLiquidoVenda - entrada;

    const dataVencBase = document.getElementById('dataVencimento').value;
    const numParcelas = parseInt(document.getElementById('numeroParcelas').value) || 1;

    if (!nome || !cpf || !dataVencBase) {
      alert("Por favor, preencha Nome, CPF e Data de Vencimento.");
      if (btn) {
        btn.disabled = false;
        btn.style.setProperty('background', '#10b981', 'important');
        btn.innerHTML = '<i class="fas fa-check-circle"></i> SALVAR';
      }
      return;
    }

    const valorParcela = Math.round((saldoDevedor / numParcelas) * 100) / 100;
    const idVendaUnico = 'V' + Date.now();

    // 2. MONTAGEM DAS PARCELAS
    const parcelasParaBanco = [];
    for (let i = 0; i < numParcelas; i++) {
      let d = new Date(dataVencBase + 'T00:00:00');
      d.setMonth(d.getMonth() + i);
      parcelasParaBanco.push({
        id_venda: idVendaUnico, 
        cliente: nome, 
        telefone: tel, 
        cpf: cpf, 
        endereco: enderecoCompleto, 
        produto: listaProdutosTxt, 
        valor_total: valorLiquidoVenda, 
        parcela: `${i + 1}/${numParcelas}`,
        valor_parcela: (i === 0 && saldoDevedor <= 0) ? 0 : valorParcela, 
        valor_pago: 0,
        data_vencimento: d.toISOString().split('T')[0], 
        status: 'Pendente', 
        forma_pagamento: formaPagamento,
        entrada: i === 0 ? entrada : 0, 
        trabalho: trabalho, 
        desconto_vendedor: descVendedor
      });
    }

    // 3. ENVIO PARA SUPABASE
    const resVenda = await fetch(`${SB_URL}/vendas`, {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(parcelasParaBanco)
    });

    if (!resVenda.ok) throw new Error("Erro ao salvar venda no banco.");

    await fetch(`${SB_URL}/clientes`, {
      method: 'POST',
      headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
      body: JSON.stringify({ cliente_nome: nome, cpf_cnpj: cpf, telefone: tel, email: emailValor, logradouro: rua, numero: num, bairro: bairro, cidade: cidade })
    });

    // --- SUCESSO: ENVIO PARA O N8N (CADASTRO COMPLETO) ---
    if (!enviandoVendaAgora) {
      enviandoVendaAgora = true;
      
      // Criando o array que o seu n8n "Code in JavaScript1" exige
      const arrayPlanoPagamento = parcelasParaBanco.map(p => {
        const [ano, mes, dia] = p.data_vencimento.split('-');
        return {
          parcela: p.parcela,
          valor: p.valor_parcela.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
          vencimento: `${dia}/${mes}/${ano}`
        };
      });

      const dadosN8N = {
        nome: nome,
        telefone: tel,
        cpf: cpf,
        trabalho: trabalho || "Não informado",
        enderecoCompleto: enderecoCompleto,
        produto: listaProdutosTxt,
        valorTotal: valorLiquidoVenda,
        entrada: entrada,
        parcelas: numParcelas,
        vencimento: dataVencBase,
        pagamento: (entrada >= valorLiquidoVenda - 0.01) ? "vista" : "parcelado",
        descontoExtra: descVendedor || 0, // Campo que você mostrou no print
        planoPagamento: arrayPlanoPagamento   // O array de parcelas que o n8n precisa
      };

      fetch(URL_N8N_CADASTRO, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dadosN8N)
      })
      .then(() => console.log("✅ Webhook de cadastro enviado com Plano de Pagamento!"))
      .catch(err => console.error("❌ Erro ao enviar Webhook:", err))
      .finally(() => { enviandoVendaAgora = false; });
    }

    alert("✅ Venda e Cliente salvos com sucesso!");

    if (btn) {
      btn.disabled = true;
      btn.style.setProperty('background', '#64748b', 'important');
      btn.innerHTML = '<i class="fas fa-lock"></i> VENDA SALVA';
    }

    if (btnComp) {
      btnComp.disabled = false;
      btnComp.style.opacity = "1";
      btnComp.style.cursor = "pointer";
    }

  } catch (error) {
    console.error("Erro Geral:", error);
    alert("🚨 Falha ao salvar: " + error.message);
    if (btn) {
      btn.disabled = false;
      btn.style.setProperty('background', '#10b981', 'important');
      btn.innerHTML = '<i class="fas fa-check-circle"></i> SALVAR';
    }
  }
}


function enviarConfirmacaoParaN8N(vendaObjeto, valorRecebido, valorOriginal) {
  const webhookURL = "https://n8n.vps6993.panel.icontainer.net/webhook/crm-vendaconfirmada";

  // Lógica: Se o valor recebido for menor que o original, é PARCIAL
  const tipoPagamento = (parseFloat(valorRecebido) < parseFloat(valorOriginal) - 0.01) ? "PARCIAL" : "TOTAL";

  // AGORA USAMOS OS NOMES DAS COLUNAS DO SUPABASE
  const dados = {
    cliente: vendaObjeto.cliente_nome,    // Antes era linha[h.indexOf...]
    telefone: vendaObjeto.telefone || "",  // Pegando do objeto da venda
    produto: vendaObjeto.produto || "Venda Direta", 
    parcela: vendaObjeto.qtd_parcelas,    // Ex: "1/3"
    valor_pago: valorRecebido,
    valor_original: valorOriginal,
    tipo: tipoPagamento, 
    data_pagamento: new Date().toLocaleDateString('pt-BR'),
    status: 'paga',
    id_venda: vendaObjeto.id_venda        // Útil para o n8n saber qual venda é
  };

  fetch(webhookURL, { 
    method: 'POST', 
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(dados) 
  })
  .then(() => console.log("n8n enviado com sucesso: " + tipoPagamento))
  .catch(err => console.error("Erro ao disparar n8n:", err));
}

async function abrirExcluir(idBanco) {
  // Procura o objeto completo nos nossos dados locais usando o ID único do Supabase
  const dado = dadosPlanilha.find(item => item.id === idBanco);
  if (!dado) return;

  // --- SE ESTIVER NA ABA DE PRODUTOS ---
  if (abaAtual === 'cadastro-produtos') {
    const btn = document.getElementById('btnConfirmarExcluirProd');
    document.getElementById('modalExcluirProduto').style.display = 'flex';
    
    btn.innerHTML = "Sim, Excluir";
    btn.disabled = false;

    btn.onclick = async () => {
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Excluindo...';
      
      try {
        // 1. APAGAR IMAGEM DO BUCKET (STORAGE) SE EXISTIR
        if (dado.imagem_url && dado.imagem_url.includes('/storage/v1/object/public/produtos/')) {
          const nomeArquivo = dado.imagem_url.split('/').pop();
          const baseURL = SB_URL.replace('/rest/v1', '');

          await fetch(`${baseURL}/storage/v1/object/produtos/${nomeArquivo}`, {
            method: 'DELETE',
            headers: {
              'apikey': SB_KEY,
              'Authorization': `Bearer ${SB_KEY}`
            }
          });
          console.log("Imagem removida do storage.");
        }

        // 2. APAGAR PRODUTO DA TABELA
        const response = await fetch(`${SB_URL}/produtos?id=eq.${idBanco}`, {
          method: 'DELETE',
          headers: {
            'apikey': SB_KEY,
            'Authorization': 'Bearer ' + SB_KEY
          }
        });

        if(response.ok) {
          fecharModal('modalExcluirProduto');
          await mostrarLista('cadastro-produtos');
        } else {
          throw new Error();
        }
      } catch (err) {
        alert("Erro ao excluir produto e imagem.");
        btn.disabled = false;
        btn.innerHTML = "Sim, Excluir";
      }
    };
  } 
  // --- SE ESTIVER NA ABA DE VENDAS ---
  else {
    const idVendaAgrupador = dado.id_venda;
    document.getElementById('modalExcluir').style.display = 'flex';

    document.getElementById('btnExcluirUnica').onclick = () => processarExclusao(idBanco, idVendaAgrupador, 'unica');
    document.getElementById('btnExcluirTudo').onclick = () => processarExclusao(idBanco, idVendaAgrupador, 'total');
  }
}

async function processarExclusao(idBanco, idVendaRef, modo) {
  const btnUnica = document.getElementById('btnExcluirUnica');
  const btnTudo = document.getElementById('btnExcluirTudo');

  if (!btnUnica || !btnTudo) return;

  btnUnica.disabled = true;
  btnTudo.disabled = true;
  
  const btnAlvo = (modo === 'unica' ? btnUnica : btnTudo);
  btnAlvo.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Excluindo...`;

  try {
    const tabela = (abaAtual === 'cadastro-produtos' ? 'produtos' : 'vendas');
    let url = `${SB_URL}/${tabela}`;
    
    if (modo === 'unica') {
      url += `?id=eq.${idBanco}`;
    } else {
      url += `?id_venda=eq.${idVendaRef}`;
    }

    const response = await fetch(url, {
      method: 'DELETE',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      }
    });

    if (response.ok) {
      fecharModal(abaAtual === 'cadastro-produtos' ? 'modalExcluirProduto' : 'modalExcluir');
      await mostrarLista(abaAtual);
    } else {
      const errorData = await response.json();
      throw new Error(errorData.message || "Erro ao deletar no Supabase");
    }

  } catch (err) {
    console.error(err);
    alert("Erro ao excluir: " + err.message);
  } finally {
    btnUnica.disabled = false;
    btnTudo.disabled = false;
    btnUnica.innerHTML = "Excluir APENAS esta parcela";
    btnTudo.innerHTML = "Excluir VENDA COMPLETA";
  }
}

async function baixarResumo() {
  const area = document.getElementById('printArea');
  
  if (!area) {
    alert("ERRO: A área 'printArea' não foi encontrada no HTML!");
    return;
  }

  // Verifica se a biblioteca foi carregada
  if (typeof html2canvas === 'undefined') {
    alert("ERRO: A biblioteca html2canvas não carregou. Verifique sua internet ou o link do script.");
    return;
  }

  try {
    console.log("Iniciando conversão para imagem...");
    
    // Gera o canvas
    const canvas = await html2canvas(area, {
      backgroundColor: "#ffffff",
      scale: 2,
      logging: false,
      useCORS: true
    });

    // Converte para Base64
    const imgData = canvas.toDataURL("image/png");
    
    // Cria o link de download de forma "macho" (forçada)
    const link = document.createElement('a');
    link.style.display = 'none';
    link.href = imgData;
    link.download = `comprovante_${Date.now()}.png`;
    
    document.body.appendChild(link);
    link.click();
    
    // Limpa o link após o clique
    setTimeout(() => {
      document.body.removeChild(link);
      console.log("Download concluído!");
    }, 100);

  } catch (error) {
    console.error("Erro ao baixar:", error);
    alert("Falha ao gerar imagem: " + error.message);
  }
}

async function executarTrocaSenha() {
  const atual = document.getElementById('senhaAtual').value;
  const nova = document.getElementById('novaSenha').value;
  const confirma = document.getElementById('confirmarNovaSenha').value;
  const btn = document.getElementById('btnSalvarSenha');

  // Recupera o usuário que salvamos agora no novo Login
  const storage = localStorage.getItem('usuarioLogado');
  const userObj = storage ? JSON.parse(storage) : window.usuarioLogado;

  if (!userObj || !userObj.login) {
    return alert("Sessão expirada. Por favor, saia e entre novamente no sistema.");
  }

  if (!atual || !nova || !confirma) return alert("Preencha todos os campos!");
  if (nova !== confirma) return alert("As novas senhas não coincidem!");
  if (nova.length < 4) return alert("A senha deve ter no mínimo 4 caracteres!");

  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> SALVANDO...';

  try {
    // 1. Validação local rápida: a senha atual digitada bate com a que está na memória?
    if (atual !== userObj.senha) {
      throw new Error("A senha atual digitada está incorreta!");
    }

    // 2. Atualiza no Supabase usando o ID único do usuário
    const response = await fetch(`${SB_URL}/usuarios?id=eq.${userObj.id}`, {
      method: 'PATCH',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ senha: nova })
    });

    if (response.ok) {
      alert("Senha alterada com sucesso!");

      // Atualiza a senha na memória do navegador para a próxima troca
      userObj.senha = nova;
      localStorage.setItem('usuarioLogado', JSON.stringify(userObj));
      window.usuarioLogado = userObj;

      fecharModal('modalSenha');
      
      // Limpa os campos por segurança
      document.getElementById('senhaAtual').value = '';
      document.getElementById('novaSenha').value = '';
      document.getElementById('confirmarNovaSenha').value = '';
    } else {
      throw new Error("Erro ao salvar no banco de dados.");
    }
  } catch (err) {
    alert("Erro: " + err.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Salvar Nova Senha';
  }
}

// FUNÇÃO PARA O OLHO (Ver Senha)
function togglePassword(inputId, icone) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    icone.classList.replace('fa-eye', 'fa-eye-slash');
  } else {
    input.type = 'password';
    icone.classList.replace('fa-eye-slash', 'fa-eye');
  }
}

function togglePassword(inputId, icone) {
  const input = document.getElementById(inputId);
  if (input.type === 'password') {
    input.type = 'text';
    icone.classList.replace('fa-eye', 'fa-eye-slash');
  } else {
    input.type = 'password';
    icone.classList.replace('fa-eye-slash', 'fa-eye');
  }
}


async function solicitarRecuperacao() {
  const campo = document.getElementById('recuperarTel');
  const telInput = campo.value.trim().replace(/\D/g, ''); // Remove parênteses e traços
  const btn = document.getElementById('btnEnviarRecuperacao');

  // 1. Validação básica
  if (!telInput || telInput.length < 10) {
    return mostrarAviso('erro', 'Atenção', 'Por favor, digite um número de telefone válido com DDD!');
  }

  // Feedback visual
  btn.disabled = true;
  btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Verificando...';

  try {
    // 2. CONSULTA NO SUPABASE
    // Procuramos na tabela 'usuarios' onde a coluna 'telefone' seja igual ao digitado
    const response = await fetch(`${SB_URL}/usuarios?telefone=eq.${telInput}&select=*`, {
      method: 'GET',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      }
    });

    const dadosUsuarios = await response.json();

    // 3. VERIFICA SE O USUÁRIO EXISTE
    if (dadosUsuarios && dadosUsuarios.length > 0) {
      const usuarioEncontrado = dadosUsuarios[0];
      const webhookN8N = "https://n8n.vps6993.panel.icontainer.net/webhook/recupsenha";
      
      // 4. ENVIO PARA O N8N
      // Como você está usando mode: 'no-cors', não conseguimos ler a resposta do n8n, 
      // então seguimos o fluxo de sucesso após o envio.
      await fetch(webhookN8N, {
        method: 'POST',
        mode: 'no-cors', 
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          usuario: usuarioEncontrado.login, // Ajuste para o nome da sua coluna (ex: login ou usuario)
          senha: usuarioEncontrado.senha,
          telefone: usuarioEncontrado.telefone 
        })
      });

      mostrarAviso('sucesso', 'Enviado!', 'Seus dados de acesso foram enviados para o seu WhatsApp.');
      document.getElementById('modalEsqueci').style.display = 'none';
      campo.value = "";

    } else {
      // Caso não encontre o telefone no banco
      mostrarAviso('erro', 'Não Encontrado', 'Este telefone não está cadastrado no sistema.');
    }

  } catch (err) {
    console.error("Erro na recuperação:", err);
    mostrarAviso('erro', 'Erro', 'Ocorreu uma falha na conexão com o banco de dados.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = "Enviar";
  }
}

  function mostrarAviso(tipo, titulo, mensagem) {
  const modal = document.getElementById('modalAviso');
  const icone = document.getElementById('avisoIcone');
  const tituloEl = document.getElementById('avisoTitulo');
  const textoEl = document.getElementById('avisoTexto');

  if (tipo === 'sucesso') {
    icone.innerHTML = '<i class="fas fa-check-circle"></i>'; // Usando FontAwesome se tiver
    icone.style.color = '#10b981';
  } else if (tipo === 'erro') {
    icone.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
    icone.style.color = '#ef4444';
  } else {
    icone.innerHTML = '<i class="fas fa-info-circle"></i>';
    icone.style.color = '#3b82f6'; // Azul para avisos informativos
  }

  tituloEl.innerText = titulo;
  textoEl.innerText = mensagem;
  modal.style.display = 'flex';
}

// --- LÓGICA DE NOVA VENDA ---

// --- 1. VARIÁVEIS GLOBAIS (Deixe sempre no topo deste bloco) ---
let itensNoCarrinho = []; 
let listaProdutosSelecionados = []; 

// 1. O botão chama esta função primeiro
function prepararNovaVenda() {
    // Tenta abrir o modal de confirmação
    const modal = document.getElementById('modalConfirmar');
    
    if (modal) {
        modal.style.display = 'flex';
    } else {
        // Se o modal não existir no HTML, usa o alerta padrão do navegador
        if (confirm("Deseja realmente limpar tudo e iniciar uma nova venda?")) {
            executarLimpezaTotal();
        }
    }
}

// 2. Esta função só roda quando você confirmar (no Modal ou no Confirm)
function executarLimpezaTotal() {
    // 1. Fecha o modal de confirmação
    const modal = document.getElementById('modalConfirmar');
    if (modal) modal.style.display = 'none';

    console.log("🧹 Limpando sistema e reativando botão salvar...");

    // 2. REATIVAR O BOTÃO SALVAR (VOLTAR PARA VERDE)
    // É aqui que desfazemos o cinza e o bloqueio que a função finalizarVenda criou
    const btnFin = document.getElementById('btnFinalizar');
    if (btnFin) {
        btnFin.disabled = false;
        btnFin.style.setProperty('background', '#10b981', 'important'); // Volta para o Verde
        btnFin.style.opacity = "1";
        btnFin.style.cursor = "pointer";
        btnFin.innerHTML = '<i class="fas fa-check-circle"></i> SALVAR';
    }

    // 3. Limpa o Carrinho (Memória e Tela)
    itensNoCarrinho = [];
    const corpo = document.getElementById('corpoCarrinho');
    if (corpo) corpo.innerHTML = "";

    // 4. Lista de campos para limpar (IDs sincronizados com seu formulário)
    const campos = [
        'nomeCliente', 'telCliente', 'cpfCliente', 'emailCliente', 'cepCliente',
        'ruaCliente', 'numCliente', 'bairroCliente', 'cidadeCliente',
        'dataVencimento', 'valorEntrada', 'descontoVendedor', 
        'numeroParcelas', 'trabalhoVenda', 'qtdProduto'
    ];
    
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // 5. Reseta os Selects para o padrão
    if (document.getElementById('tipoPagamento')) document.getElementById('tipoPagamento').value = 'parcelado';
    if (document.getElementById('selectProduto')) document.getElementById('selectProduto').selectedIndex = 0;
    if (document.getElementById('numeroParcelas')) document.getElementById('numeroParcelas').value = '1';

    // 6. Zera os cálculos e o resumo visual (R$ 0,00)
    if (typeof calcularVendaFinal === "function") {
        calcularVendaFinal();
    }

    // 7. Navegação e Foco
    if (typeof navegar === 'function') navegar('cadastro-vendas');
    
    const campoNome = document.getElementById('nomeCliente');
    if(campoNome) campoNome.focus();
}

function abrirModalVenda() {
  const modal = document.getElementById('modalVenda');
  if (modal) {
    modal.style.display = 'flex';
    // Ao abrir, já limpa tudo para não vir lixo da venda anterior
    abrirNovaVenda(); 
  }
}

function fecharModal(id) {
  const target = id || 'modalVenda';
  const el = document.getElementById(target);
  
  if (el) {
    el.style.display = 'none';

    // Se o modal fechado for o de edição, limpamos o estado dele
    if (target === 'modalEdicaoCliente') {
      resetarEstadoModalCliente();
    }
  }
}

// Função auxiliar para deixar o modal "travado" e limpo de novo
function resetarEstadoModalCliente() {
  const campos = [
    'editClienteNome', 'editClienteCpf', 'editClienteTelefone', 'editClienteEmail',
    'editClienteCep', 'editClienteLogradouro', 'editClienteNumero', 
    'editClienteBairro', 'editClienteCidade'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.readOnly = true; // Trava novamente
      el.classList.add('input-travado');
      el.classList.remove('input-editavel');
    }
  });

  // Volta o botão original de "Editar"
  const container = document.getElementById('containerBotoesCliente');
  if (container) {
    container.innerHTML = `
      <button onclick="habilitarCamposCliente()" class="btn-nav" style="background: #3b82f6; width: 100%;">
        Editar Campos
      </button>
    `;
  }
}

// --- 3. CARREGAR PRODUTOS (AGORA VIA SUPABASE) ---
async function carregarProdutos() {
  // Localiza o select pelo ID que você encontrou no seu HTML
  const select = document.getElementById('selectProduto');
  
  if (!select) {
    console.error("ERRO: O elemento 'selectProduto' não existe na página.");
    return;
  }

  select.innerHTML = '<option value="">⏳ Carregando produtos...</option>';

  try {
    const response = await fetch(`${SB_URL}/produtos?select=*&order=nome.asc`, {
      method: 'GET',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      }
    });

    if (!response.ok) throw new Error("Erro ao conectar com o banco de dados.");

    const produtos = await response.json();

    if (!produtos || produtos.length === 0) {
      select.innerHTML = '<option value="">❌ Nenhum produto encontrado</option>';
      return;
    }

    // Preenche as opções
    select.innerHTML = '<option value="">Selecione um produto...</option>';
    produtos.forEach(p => {
      let opt = document.createElement('option');
      opt.value = p.nome;
      const preco = parseFloat(p.preco) || 0;
      opt.textContent = `${p.nome} - R$ ${preco.toFixed(2).replace('.', ',')}`;
      opt.setAttribute('data-preco', preco);
      select.appendChild(opt);
    });

    console.log("✅ Select 'selectProduto' preenchido!");

  } catch (err) {
    console.error("Erro técnico:", err);
    select.innerHTML = '<option value="">⚠️ Erro ao carregar</option>';
  }
}

// --- 4. ADICIONAR AO CARRINHO ---
function adicionarAoCarrinho() {
  // Tenta encontrar o select pelos dois IDs possíveis
  const select = document.getElementById('selectProduto') || document.getElementById('produtoVenda');
  const option = select ? select.options[select.selectedIndex] : null;
  
  if (!option || option.value === "") {
    alert("Por favor, selecione um produto!");
    return;
  }

  // Pega o nome puro e o preço do atributo data-preco
  const nome = option.value; 
  const preco = parseFloat(option.getAttribute('data-preco')) || 0;
  const qtdInput = document.getElementById('qtdProduto');
  const qtd = parseInt(qtdInput ? qtdInput.value : 1) || 1;

  // Verifica se o item já está no carrinho para somar
  const itemExistente = itensNoCarrinho.find(item => item.nome === nome);

  if (itemExistente) {
    itemExistente.qtd += qtd;
    itemExistente.subtotal = itemExistente.preco * itemExistente.qtd;
  } else {
    itensNoCarrinho.push({
      nome: nome,
      preco: preco,
      qtd: qtd,
      subtotal: preco * qtd
    });
  }

  // --- ATENÇÃO AQUI: Chame o nome correto da função de desenhar ---
  renderizarTabela(); 
  
  if (typeof calcularVendaFinal === "function") {
    calcularVendaFinal();
  }
  
  // Reseta os campos
  select.selectedIndex = 0;
  if(qtdInput) qtdInput.value = 1;
}

// --- 5. REMOVER ITEM ---
function removerItem(index) {
  if (confirm("Deseja remover este item do carrinho?")) {
    itensNoCarrinho.splice(index, 1);
    renderizarTabela(); // Mantendo o padrão
    if (typeof calcularVendaFinal === "function") {
      calcularVendaFinal();
    }
  }
}

// --- 6. RENDERIZAR TABELA (AQUI ELA LIMPA O HTML) ---
function renderizarTabela() {
  const corpo = document.getElementById('corpoCarrinho');
  if (!corpo) return;
  
  corpo.innerHTML = ""; // Limpa a tabela visualmente

  itensNoCarrinho.forEach((item, index) => {
    // Garantimos que os valores são números para evitar erro de .toFixed
    const preco = parseFloat(item.preco) || 0;
    const subtotal = parseFloat(item.subtotal) || 0;

    corpo.innerHTML += `
      <tr style="border-bottom: 1px solid #334155; background: #0f172a;">
        <td style="padding: 12px; text-align: left; color: white !important;">${item.nome}</td>
        <td style="padding: 12px; text-align: center; color: white !important;">${item.qtd}</td>
        <td style="padding: 12px; text-align: center; color: white !important;">R$ ${preco.toFixed(2).replace('.', ',')}</td>
        <td style="padding: 12px; text-align: center; font-weight: bold; color: #38bdf8 !important;">R$ ${subtotal.toFixed(2).replace('.', ',')}</td>
        <td style="padding: 12px; text-align: center;">
          <button type="button" onclick="removerItem(${index})" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      </tr>
    `;
  });
}

// 1. CÁLCULO DINÂMICO (CONSIDERANDO ENTRADA NO TOTAL LÍQUIDO)
function calcularVendaFinal() {
  // 1. Soma bruta dos itens no carrinho
  let bruto = itensNoCarrinho.reduce((acc, item) => acc + item.subtotal, 0);
  
  const tipo = document.getElementById('tipoPagamento').value;
  const entrada = parseFloat(document.getElementById('valorEntrada').value) || 0;
  const descontoExtra = parseFloat(document.getElementById('descontoVendedor').value) || 0;
  const parcelasInput = document.getElementById('numeroParcelas'); 
  const labelDesconto = document.getElementById('labelDesconto');

  let descontoSistema = 0;
  
  // 2. Lógica de Desconto à Vista (Tag Amarela)
  if (tipo === 'vista') {
      descontoSistema = bruto * 0.10;
      if (labelDesconto) {
          labelDesconto.style.display = 'inline-block';
          labelDesconto.style.background = '#fbbf24';
          labelDesconto.style.color = '#000';
          labelDesconto.innerHTML = `<i class="fas fa-tag"></i> DESCONTO 10% APLICADO`;
      }
      parcelasInput.value = 1;
      parcelasInput.disabled = true;
  } else {
      if (labelDesconto) labelDesconto.style.display = 'none';
      parcelasInput.disabled = false;
  }

  // 3. Cálculos de Saldo
  // Valor da Venda = Bruto - Desconto Sistema - Desconto Vendedor
  const valorVendaFinal = bruto - descontoSistema - descontoExtra;
  
  // Saldo Devedor = Valor da Venda - Entrada (O que falta pagar)
  const saldoDevedor = valorVendaFinal - entrada;
  
  const numParcelas = parseInt(parcelasInput.value) || 1;
  const valorParcela = saldoDevedor > 0 ? (saldoDevedor / numParcelas) : 0;

  const f = (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

  // 4. Atualiza o Total Líquido na tela (O valor grande agora subtrai a entrada)
  // Se você quer que o total grande mostre quanto falta pagar:
  document.getElementById('valorTotal').innerText = f(saldoDevedor > 0 ? saldoDevedor : 0);

  // 5. RESUMO VISUAL: A "Conta Armada"
  const resumoArea = document.getElementById('resumoParcelas');
  let linhasResumo = [];

  // Linha do Subtotal
  linhasResumo.push(`<span style="font-size: 0.85rem; color: #94a3b8;">Subtotal: ${f(bruto)}</span>`);

  // Descontos em Amarelo
  if (descontoSistema > 0) {
      linhasResumo.push(`<span style="font-size: 0.85rem; color: #fbbf24;">- ${f(descontoSistema)} (10% à vista)</span>`);
  }
  if (descontoExtra > 0) {
      linhasResumo.push(`<span style="font-size: 0.85rem; color: #fbbf24;">- ${f(descontoExtra)} vendedor</span>`);
  }

  // Entrada em Vermelho (Subtraindo da conta)
  if (entrada > 0) {
      linhasResumo.push(`<span style="font-size: 0.85rem; color: #f87171; font-weight: bold;">- ${f(entrada)} ENTRADA</span>`);
  }

  // Linha separadora
  let htmlFinal = linhasResumo.join('<br>');
  htmlFinal += `<div style="border-top: 1px solid #475569; margin: 5px 0; width: 60%; margin-left: auto;"></div>`;
  
  // Valor final das parcelas em Azul
  htmlFinal += `<strong style="color: #60a5fa; font-size: 1.1rem;">${numParcelas}x de ${f(valorParcela)}</strong>`;
  
  resumoArea.innerHTML = `<div style="text-align: right; line-height: 1.4;">${htmlFinal}</div>`;
}

// URL do seu Webhook n8n
const URL_N8N_CADASTRO = "https://n8n.vps6993.panel.icontainer.net/webhook/MEIRELLES-CADASTRO";
const URL_N8N_PAGAMENTO = "https://n8n.vps6993.panel.icontainer.net/webhook/crm-vendaconfirmada";

// Variável global para evitar envios duplicados
let enviandoVendaAgora = false;



// Função Auxiliar para busca de CEP (Opcional)
function buscaCep() {
  const cep = document.getElementById('cepCliente').value.replace(/\D/g, '');
  if (cep.length === 8) {
    fetch('https://viacep.com.br/ws/' + cep + '/json/')
      .then(res => res.json())
      .then(dados => {
        if (!dados.erro) {
          document.getElementById('ruaCliente').value = dados.logradouro;
          document.getElementById('bairroCliente').value = dados.bairro;
          document.getElementById('cidadeCliente').value = dados.localidade;
        }
      });
  }
}

function imprimirComprovante() {
    console.log("Gerando recibo...");

    // 1. CAPTURA DOS DADOS
    const nome = document.getElementById('nomeCliente')?.value || "Não informado";
    const cpf = document.getElementById('cpfCliente')?.value || "Não informado";
    const rua = document.getElementById('ruaCliente')?.value || ""; 
    const numero = document.getElementById('numCliente')?.value || ""; 
    const bairro = document.getElementById('bairroCliente')?.value || "";
    const cidade = document.getElementById('cidadeCliente')?.value || "";
    
    // Tenta pegar o total de dois IDs possíveis
    const totalElemento = document.getElementById('valorTotalVenda') || document.getElementById('valorTotal');
    const totalLiquidoTexto = totalElemento?.value || totalElemento?.innerText || "R$ 0,00";
    
    const pagamento = document.getElementById('tipoPagamento')?.value === 'vista' ? 'À Vista' : 'Parcelado';
    const parcelas = document.getElementById('numeroParcelas')?.value || "1";
    
    const entradaValor = parseFloat(document.getElementById('valorEntrada')?.value) || 0;
    const entradaHTML = entradaValor > 0 ? `<p style="margin:3px 0;">ENTRADA: <strong>R$ ${entradaValor.toFixed(2).replace('.', ',')}</strong></p>` : '';

    const descontoValor = parseFloat(document.getElementById('descontoVendedor')?.value) || 0;
    const descontoHTML = descontoValor > 0 ? `<p style="margin:3px 0; color: #000;">DESCONTO: <strong>R$ ${descontoValor.toFixed(2).replace('.', ',')}</strong></p>` : '';

    const dataInput = document.getElementById('dataVencimento')?.value;
    const dataVenc = dataInput ? dataInput.split('-').reverse().join('/') : '--/--/----';

    // 2. MONTAGEM DO ELEMENTO (ESCONDIDO)
    const recibo = document.createElement('div');
    recibo.style.cssText = "width: 400px; padding: 20px; background: #ffffff; color: #000; font-family: Courier New, Courier, monospace; position: absolute; left: -9999px; top: 0;";

    recibo.innerHTML = `
        <div style="text-align:center; margin-bottom: 15px;">
            <img src="https://i.postimg.cc/N0D8vD8T/crediariomeirelles.jpg" crossorigin="anonymous" style="width: 250px; height: auto; margin-bottom: 10px;">
            <div style="border-top: 1px dashed #000; border-bottom: 1px dashed #000; padding: 5px 0; margin-top: 10px;">
                <strong style="font-size: 16px;">COMPROVANTE DE VENDA</strong>
            </div>
        </div>
        
        <div style="margin-bottom: 15px; font-size: 13px; line-height: 1.4;">
            <strong>CLIENTE:</strong> ${nome}<br>
            <strong>CPF:</strong> ${cpf}<br>
            <strong>ENDEREÇO:</strong> ${rua}${numero ? ', ' + numero : ''}<br>
            <strong>BAIRRO:</strong> ${bairro} - ${cidade}<br>
            <strong>DATA:</strong> ${new Date().toLocaleString('pt-BR')}
        </div>

        <div style="border-bottom: 1px dashed #000; margin-bottom: 10px;">
            <table style="width:100%; font-size:12px; border-collapse:collapse;">
                <thead>
                    <tr style="border-bottom: 1px solid #000;">
                        <th style="text-align:left; padding-bottom:5px;">PRODUTO</th>
                        <th style="text-align:right; padding-bottom:5px;">VALOR</th>
                    </tr>
                </thead>
                <tbody>
                    ${itensNoCarrinho.length > 0 ? 
                        itensNoCarrinho.map(i => `
                            <tr>
                                <td style="padding:5px 0;">${i.qtd}x ${i.nome}</td>
                                <td style="text-align:right;">R$ ${i.subtotal.toFixed(2).replace('.', ',')}</td>
                            </tr>
                        `).join('') : 
                        `<tr><td colspan="2" style="text-align:center;">Venda Avulsa</td></tr>`
                    }
                </tbody>
            </table>
        </div>

        <div style="text-align:right; font-size:14px;">
            <p style="margin:3px 0;">FORMA DE PGTO: <strong>${pagamento}</strong></p>
            ${descontoHTML}
            ${entradaHTML}
            <p style="margin:3px 0;">PARCELAS: <strong>${parcelas}</strong></p>
            <p style="margin:3px 0; font-size: 18px;"><strong>TOTAL: ${totalLiquidoTexto}</strong></p>
            <p style="margin:3px 0; font-size:11px;">1ª PARCELA: ${dataVenc}</p>
        </div>

        <div style="margin-top:30px; text-align:center; font-size:11px; border-top: 1px dashed #000; padding-top: 15px;">
            <p style="margin:0;">OBRIGADO PELA PREFERÊNCIA!</p>
            <p style="margin:5px 0; font-weight: bold;">CREDIÁRIO MEIRELLES</p>
            <p style="margin:0; font-size: 9px;">Este documento não possui valor fiscal.</p>
        </div>
    `;

    document.body.appendChild(recibo);

    // 3. GERAÇÃO DA IMAGEM (COM CORREÇÃO DE DOWNLOAD)
    setTimeout(() => {
        html2canvas(recibo, { 
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff"
        }).then(canvas => {
            const link = document.createElement('a');
            link.download = `Recibo_${nome.split(' ')[0] || 'Venda'}.png`;
            link.href = canvas.toDataURL("image/png");
            
            // O segredo está aqui: anexar o link antes de clicar
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            document.body.removeChild(recibo);
            console.log("Recibo baixado!");
        }).catch(err => {
            console.error("Erro ao gerar imagem:", err);
            if(document.body.contains(recibo)) document.body.removeChild(recibo);
        });
    }, 800); // Aumentei um pouco o tempo para garantir o carregamento do logo
}

// Função que o botão "NOVA VENDA" chama
function executarLimpezaTotal() {
    const modal = document.getElementById('modalConfirmar');
    if (modal) modal.style.display = 'none';

    // 1. CORREÇÃO: Use o mesmo nome da variável da função finalizarVenda
    enviandoVendaAgora = false; 

    // 2. Reseta o Botão "SALVAR" para VERDE
    const btnFin = document.getElementById('btnFinalizar');
    if (btnFin) {
        btnFin.disabled = false;
        btnFin.style.setProperty('background', '#10b981', 'important'); 
        btnFin.style.opacity = "1";
        btnFin.innerHTML = '<i class="fas fa-check-circle"></i> SALVAR';
    }

    // 3. Reseta o Botão de Recibo
    const btnComp = document.getElementById('btnComprovante');
    if (btnComp) {
        btnComp.disabled = true;
        btnComp.style.opacity = "0.5";
    }

    // 4. Limpa os campos (Adicionado 'clienteEmail')
    const campos = [
        'nomeCliente', 'telCliente', 'cpfCliente', 'clienteEmail', // <-- Adicionado aqui
        'trabalhoCliente', 'cepCliente', 'ruaCliente', 'numComplemento', 
        'bairroCliente', 'cidadeCliente', 'dataVencimento', 'valorEntrada', 
        'numeroParcelas', 'descontoVendedor', 'qtdProduto'
    ];
    
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = "";
    });

    // 5. Limpa o Carrinho
    itensNoCarrinho = [];
    const corpo = document.getElementById('corpoCarrinho');
    if (corpo) corpo.innerHTML = ""; 
    
    // Atualiza os cálculos na tela (Total R$ 0,00)
    if (typeof calcularVendaFinal === "function") {
        calcularVendaFinal();
    }

    // 6. Reseta Selects
    if (document.getElementById('tipoPagamento')) document.getElementById('tipoPagamento').value = 'parcelado';
    if (document.getElementById('numeroParcelas')) document.getElementById('numeroParcelas').value = '1';
    if (document.getElementById('selectProduto')) document.getElementById('selectProduto').selectedIndex = 0;

    const campoNome = document.getElementById('nomeCliente');
    if(campoNome) campoNome.focus();
}

// --- FUNÇÕES DE EDIÇÃO DE PRODUTO (CORRIGIDAS) ---

// --- FUNÇÕES DE EDIÇÃO DE PRODUTO (ATUALIZADAS COM URL) ---

async function abrirEdicaoProduto(id) {
  // 1. Procura o produto na sua lista global
  const produto = dadosPlanilha.find(p => p.id === id); 
  
  if (!produto) {
    console.error("Produto não encontrado!");
    return;
  }

  // --- O PULO DO GATO ---
  // Salva a URL atual na variável global para usarmos na hora de deletar do Bucket
  urlOriginalAntesDeEditar = produto.imagem_url || "";
  console.log("📸 URL original guardada para limpeza futura:", urlOriginalAntesDeEditar);

  const preencherSeExiste = (idElemento, valor) => {
    const el = document.getElementById(idElemento);
    if (el) el.value = valor || "";
  };

  // 2. Preenchimento Seguro
  preencherSeExiste('editProdId',        produto.id);
  preencherSeExiste('editProdCategoria', produto.categoria);
  preencherSeExiste('editProdNome',      produto.nome);
  preencherSeExiste('editProdPreco',     produto.preco);
  preencherSeExiste('editProdEstoque',   produto.estoque);
  preencherSeExiste('editProdUrl',       produto.imagem_url);
  preencherSeExiste('editProdCor',       produto.cor);

  // 3. Reset visual (Volta a travar os campos)
  const campos = ['editProdCategoria', 'editProdNome', 'editProdPreco', 'editProdEstoque', 'editProdUrl', 'editProdCor'];
  campos.forEach(idCampo => {
    const el = document.getElementById(idCampo);
    if (el) {
      el.readOnly = true;
      el.style.backgroundColor = ""; 
      el.style.border = "";
    }
  });

  // 4. RESET DOS BOTÕES
  const btnEditar = document.getElementById('btnHabilitarEdicao');
  const btnSalvar = document.getElementById('btnSalvarEdicao');
  const btnUpload = document.getElementById('btnUploadEdicao');

  if (btnEditar) btnEditar.style.display = 'block';
  if (btnSalvar) btnSalvar.style.display = 'none';
  
  if (btnUpload) {
    btnUpload.disabled = true;
    btnUpload.style.opacity = "0.5";
  }

  // 5. ABRE O MODAL
  const modal = document.getElementById('modalEdicaoProduto');
  if (modal) modal.style.display = 'flex';
}


function habilitarCamposProduto() {
    // 1. IDs dos campos que vamos destravar (IDs que estão no seu HTML)
    const campos = ['editProdCategoria', 'editProdNome', 'editProdPreco', 'editProdEstoque', 'editProdCor', 'editProdUrl'];
    
    campos.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.readOnly = false;
            // Estilo visual para mostrar que está editável
            el.style.backgroundColor = "rgba(255, 255, 255, 0.05)"; 
            el.style.border = "1px solid #38bdf8";
        }
    });

    // 2. Libera o botão da nuvem (Upload)
    const btnUpload = document.getElementById('btnUploadEdicao');
    if (btnUpload) {
        btnUpload.disabled = false;
        btnUpload.style.opacity = "1";
    }

    // 3. A MÁGICA: Esconde um botão e mostra o outro
    const btnEditar = document.getElementById('btnHabilitarEdicao');
    const btnSalvar = document.getElementById('btnSalvarEdicao');

    if (btnEditar) btnEditar.style.display = 'none';
    if (btnSalvar) btnSalvar.style.display = 'block'; // Aqui ele aparece!
}


function cancelarEdicaoProduto() {
  // Adicionei 'editProdCor' à lista para garantir que ele também seja travado
  const campos = ['editProdCategoria', 'editProdNome', 'editProdPreco', 'editProdEstoque', 'editProdUrl', 'editProdCor'];
  
  campos.forEach(id => {
    const el = document.getElementById(id);
    if(el) {
      el.readOnly = true;
      el.classList.remove('input-editavel');
      el.classList.add('input-travado');
    }
  });

  // Atualiza os botões para o estado inicial (Apenas visualização)
  document.getElementById('containerBotoesProd').innerHTML = `
    <button onclick="habilitarCamposProduto()" class="btn-login-glow" style="background: #f59e0b; width:100%; border:none; color:white; padding:10px; border-radius:8px; cursor:pointer; font-weight:600;">
      <i class="fas fa-pencil-alt"></i> EDITAR CAMPOS
    </button>
    <button class="btn-cancelar" onclick="fecharModal('modalEdicaoProduto')" style="width:100%; margin-top:8px; background:#1e293b; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">
      VOLTAR
    </button>
  `;
}

async function confirmarSalvarProduto() {
  const idProduto = document.getElementById('editProdId').value;
  const btn = document.getElementById('btnSalvarEdicao');
  const inputUrl = document.getElementById('editProdUrl'); 
  
  const urlNoCampoAgora = inputUrl.value.trim();
  const baseURL = SB_URL.replace('/rest/v1', '');
  let urlFinalParaBanco = urlNoCampoAgora; 

  try {
    if (btn) {
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> PROCESSANDO...';
    }

    // --- LOGICA DE LIMPEZA: Se o link mudou (ou sumiu) e o antigo era do Supabase, deleta ---
    const linkMudou = urlNoCampoAgora !== urlOriginalAntesDeEditar;
    const antigoEraSupa = urlOriginalAntesDeEditar && urlOriginalAntesDeEditar.includes('produtos/');

    if (linkMudou && antigoEraSupa) {
        try {
          const nomeArquivoAntigo = urlOriginalAntesDeEditar.split('/').pop().split('?')[0];
          const urlDeExclusao = `${baseURL}/storage/v1/object/produtos/${nomeArquivoAntigo}`;
          
          console.log("🧹 Detectada troca de link (manual ou vazio). Limpando bucket:", nomeArquivoAntigo);

          await fetch(urlDeExclusao, {
            method: 'DELETE',
            headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
          });
        } catch (e) {
          console.warn("Aviso: Falha ao deletar arquivo antigo.");
        }
    }

    // --- LOGICA DE UPLOAD: Se escolheu arquivo novo, ele sobrescreve o link manual ---
    if (arquivoTemporarioEdicao) {
      const extensao = arquivoTemporarioEdicao.name.split('.').pop();
      const nomeArquivoNovo = `prod_edit_${Date.now()}.${extensao}`;

      const uploadResponse = await fetch(`${baseURL}/storage/v1/object/produtos/${nomeArquivoNovo}`, {
        method: 'POST',
        headers: {
          'apikey': SB_KEY,
          'Authorization': `Bearer ${SB_KEY}`,
          'Content-Type': arquivoTemporarioEdicao.type
        },
        body: arquivoTemporarioEdicao
      });

      if (uploadResponse.ok) {
        urlFinalParaBanco = `${baseURL}/storage/v1/object/public/produtos/${nomeArquivoNovo}`;
        inputUrl.value = urlFinalParaBanco;
      } else {
        throw new Error("Falha no upload da nova imagem.");
      }
    }

    // --- SALVAR NO BANCO ---
    const dados = {
      categoria:  document.getElementById('editProdCategoria').value,
      nome:       document.getElementById('editProdNome').value,
      preco:      parseFloat(document.getElementById('editProdPreco').value.toString().replace(',', '.')) || 0,
      imagem_url: urlFinalParaBanco,
      estoque:    parseInt(document.getElementById('editProdEstoque').value) || 0,
      cor:        document.getElementById('editProdCor')?.value || ""
    };

    const response = await fetch(`${SB_URL}/produtos?id=eq.${idProduto}`, {
      method: 'PATCH',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(dados)
    });

    if (response.ok) {
      if (typeof mostrarLista === 'function') await mostrarLista('cadastro-produtos');
      alert("✅ Atualizado com sucesso e bucket limpo!");
      fecharModal('modalEdicaoProduto');
      
      // Reseta tudo
      arquivoTemporarioEdicao = null;
      urlOriginalAntesDeEditar = "";
    }

  } catch (err) {
    alert("Erro: " + err.message);
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save"></i> SALVAR ALTERAÇÕES';
    }
  }
}

async function cadastrarNovoUsuario() {
    const loginNovo = document.getElementById('novoLoginUsuario').value.trim();
    const senhaNova = document.getElementById('novaSenhaUsuario').value.trim();
    const telNovo = document.getElementById('novoTelUsuario').value.trim().replace(/\D/g, '');
    const btn = document.getElementById('btnConfirmarNovoUsuario');

    if (!loginNovo || !senhaNova) {
        return mostrarAviso('erro', 'Campos Vazios', 'Informe pelo menos o nome de usuário e a senha!');
    }

    btn.disabled = true;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cadastrando...';

    try {
        const response = await fetch(`${SB_URL}/usuarios`, {
            method: 'POST',
            headers: {
                'apikey': SB_KEY,
                'Authorization': 'Bearer ' + SB_KEY,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify([{
                login: loginNovo.toLowerCase(),
                senha: senhaNova,
                telefone: telNovo
            }])
        });

        if (response.ok) {
            mostrarAviso('sucesso', 'Sucesso!', 'Novo usuário cadastrado com sucesso.');
            fecharModal('modalNovoUsuario');
            
            // Limpa os campos
            document.getElementById('novoLoginUsuario').value = '';
            document.getElementById('novaSenhaUsuario').value = '';
            document.getElementById('novoTelUsuario').value = '';
        } else {
            throw new Error("Erro ao inserir no banco de dados.");
        }
    } catch (err) {
        console.error(err);
        mostrarAviso('erro', 'Falha', 'Não foi possível cadastrar o usuário.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'Cadastrar Usuário';
    }
}

function abrirModalNovoUsuario() {
    fecharModal('modalSenha'); // Fecha o de troca de senha
    document.getElementById('modalNovoUsuario').style.display = 'flex'; // Abre o de novo cadastro
}

/**
 * 1. ABRE O MODAL E PREENCHE OS DADOS (MODO LEITURA)
 */
async function abrirEdicaoCliente(id) {
  console.log("Procurando cliente com ID:", id);
  const cliente = dadosPlanilha.find(c => String(c.id) === String(id));
  
  if (!cliente) {
    console.error("Cliente não encontrado no array dadosPlanilha");
    return;
  }

  // --- O PULO DO GATO ---
  // Guarda a URL atual na variável global antes de qualquer edição
  urlFotoClienteOriginal = cliente.foto_url || "";
  console.log("📸 URL da foto do cliente guardada para limpeza futura:", urlFotoClienteOriginal);

  try {
    // 1. Preenche os campos de texto
    document.getElementById('editClienteId').value = cliente.id || "";
    document.getElementById('editClienteNome').value = cliente.cliente_nome || ""; 
    document.getElementById('editClienteCpf').value = cliente.cpf_cnpj || "";
    document.getElementById('editClienteTelefone').value = cliente.telefone || "";
    document.getElementById('editClienteEmail').value = cliente.email || "";
    document.getElementById('editClienteCep').value = cliente.cep || "";
    document.getElementById('editClienteLogradouro').value = cliente.logradouro || "";
    document.getElementById('editClienteNumero').value = cliente.numero || "";
    document.getElementById('editClienteBairro').value = cliente.bairro || "";
    document.getElementById('editClienteCidade').value = cliente.cidade || "";

    // 2. Carrega a Foto (Preview)
    const imgPreview = document.getElementById('editPreviewFoto');
    const iconePadrao = document.getElementById('editIconePadrao');

    if (cliente.foto_url) {
      imgPreview.src = cliente.foto_url;
      imgPreview.style.display = 'block';
      iconePadrao.style.display = 'none';
    } else {
      imgPreview.src = "";
      imgPreview.style.display = 'none';
      iconePadrao.style.display = 'block';
    }

    // 3. Exibe o modal e reseta para modo leitura
    const modal = document.getElementById('modalEdicaoCliente');
    if (modal) modal.style.display = 'flex';
    
    resetarEstadoModalCliente(); 
    console.log("✅ Modal aberto com foto para:", cliente.cliente_nome);

  } catch (e) {
    console.error("Erro ao abrir modal de edição:", e);
  }
}

function resetarEstadoModalCliente() {
  const container = document.getElementById('containerBotoesCliente');
  if (container) {
    container.innerHTML = `
      <button type="button" onclick="habilitarCamposCliente()" 
        style="background:#f59e0b; border:none; color:white; padding:12px; border-radius:8px; cursor:pointer; width:100%; font-weight:600;">
        <i class="fas fa-edit"></i> EDITAR DADOS
      </button>
    `;
  }

  const campos = [
    'editClienteNome', 'editClienteCpf', 'editClienteTelefone', 'editClienteEmail',
    'editClienteCep', 'editClienteLogradouro', 'editClienteNumero', 
    'editClienteBairro', 'editClienteCidade'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.readOnly = true;
      el.classList.add('input-travado');
      el.classList.remove('input-editavel');
    }
  });

  // TRAVA A FOTO: impede clique e deixa fosco
  const areaFoto = document.getElementById('areaFotoCliente');
  if (areaFoto) {
    areaFoto.style.pointerEvents = 'none';
    areaFoto.style.opacity = '0.7';
  }
}

function habilitarCamposCliente() {
  const campos = [
    'editClienteNome', 'editClienteCpf', 'editClienteTelefone', 'editClienteEmail',
    'editClienteCep', 'editClienteLogradouro', 'editClienteNumero', 
    'editClienteBairro', 'editClienteCidade'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.readOnly = false;
      el.classList.remove('input-travado');
      el.classList.add('input-editavel');
    }
  });

  // DESTRAVA A FOTO: permite clique para trocar
  const areaFoto = document.getElementById('areaFotoCliente');
  if (areaFoto) {
    areaFoto.style.pointerEvents = 'auto';
    areaFoto.style.opacity = '1';
  }

  const container = document.getElementById('containerBotoesCliente');
  if (container) {
    container.innerHTML = `
      <button type="button" id="btnSalvarCliente" onclick="salvarEdicaoCliente()" 
        style="background:#10b981; border:none; color:white; padding:12px; border-radius:8px; cursor:pointer; width:100%; font-weight:600; margin-bottom:8px;">
        <i class="fas fa-check-circle"></i> GRAVAR ALTERAÇÕES
      </button>
      <button type="button" onclick="resetarEstadoModalCliente()" 
        style="width:100%; background:#64748b; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">
        CANCELAR EDIÇÃO
      </button>
    `;
  }
}

/**
 * 4. ENVIA AS ALTERAÇÕES PARA O SUPABASE
 */
async function salvarEdicaoCliente(event) {
  if (event) event.preventDefault();

  const btn = document.getElementById('btnSalvarCliente');
  const idCliente = document.getElementById('editClienteId').value;
  const inputArquivo = document.getElementById('editInputFile');

  if (!idCliente) {
    alert("Erro: ID do cliente não localizado.");
    return;
  }

  let textoOriginal = "SALVAR ALTERAÇÕES";
  if (btn) {
    textoOriginal = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SALVANDO...';
  }

  try {
    let fotoUrlFinal = null;
    const baseURL = SB_URL.replace('/rest/v1', '');

    // --- PASSO 1: UPLOAD E LIMPEZA ---
    if (inputArquivo && inputArquivo.files.length > 0) {
      if (urlFotoClienteOriginal && urlFotoClienteOriginal.includes('fotos-clientes/')) {
        try {
          const nomeArquivoAntigo = urlFotoClienteOriginal.split('/').pop().split('?')[0];
          const urlDeExclusao = `${baseURL}/storage/v1/object/fotos-clientes/${nomeArquivoAntigo}`;
          
          await fetch(urlDeExclusao, {
            method: 'DELETE',
            headers: { 'apikey': SB_KEY, 'Authorization': `Bearer ${SB_KEY}` }
          });
          console.log("🧹 Foto antiga removida.");
        } catch (e) {
          console.warn("Falha ao deletar antiga, seguindo...");
        }
      }

      const arquivo = inputArquivo.files[0];
      const extensao = arquivo.name.split('.').pop();
      const nomeArquivo = `${idCliente}_${Date.now()}.${extensao}`;
      
      const uploadResponse = await fetch(`${baseURL}/storage/v1/object/fotos-clientes/${nomeArquivo}`, {
        method: 'POST',
        headers: {
          'apikey': SB_KEY,
          'Authorization': `Bearer ${SB_KEY}`,
          'Content-Type': arquivo.type
        },
        body: arquivo
      });

      if (uploadResponse.ok) {
        fotoUrlFinal = `${baseURL}/storage/v1/object/public/fotos-clientes/${nomeArquivo}`;
      } else {
        throw new Error("Erro ao subir nova imagem.");
      }
    }

    // --- PASSO 2: PAYLOAD ---
    const dadosCliente = {
      cliente_nome: document.getElementById('editClienteNome').value,
      cpf_cnpj:     document.getElementById('editClienteCpf').value,
      telefone:     document.getElementById('editClienteTelefone').value,
      email:        document.getElementById('editClienteEmail').value,
      cep:          document.getElementById('editClienteCep').value,
      logradouro:   document.getElementById('editClienteLogradouro').value,
      numero:       document.getElementById('editClienteNumero').value,
      bairro:       document.getElementById('editClienteBairro').value,
      cidade:       document.getElementById('editClienteCidade').value
    };

    if (fotoUrlFinal) dadosCliente.foto_url = fotoUrlFinal;

    // --- PASSO 3: PATCH ---
    const response = await fetch(`${SB_URL}/clientes?id=eq.${idCliente}`, {
      method: 'PATCH',
      headers: {
        'apikey': SB_KEY,
        'Authorization': 'Bearer ' + SB_KEY,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(dadosCliente) 
    });

    if (response.ok) {
      // --- PASSO 4: ATUALIZAÇÃO DA LISTA (ANTES DO ALERT) ---
      console.log("🔄 Sincronizando tabela...");
      if (typeof mostrarLista === 'function') {
          await mostrarLista('cadastro-clientes');
      }

      alert("✅ Cliente atualizado com sucesso!");
      fecharModal('modalEdicaoCliente');
      
      // Limpa a memória da foto
      urlFotoClienteOriginal = ""; 

    } else {
      const errorData = await response.json();
      throw new Error(errorData.message || "Falha ao atualizar cliente.");
    }

  } catch (err) {
    console.error("Erro:", err);
    alert("Erro ao salvar: " + err.message);
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.innerHTML = textoOriginal;
    }
  }
}

function cancelarEdicaoCliente() {
  document.getElementById('modalEdicaoCliente').style.display = 'none';
}

function irParaClientes() {
  abaAtual = 'cadastro-clientes';
  paginaAtual = 1;
  mostrarLista('cadastro-clientes');
}

function habilitarEdicao() {
  // Lista de todos os seus IDs de input no modal
  const campos = [
    'editClienteNome', 'editClienteCpf', 'editClienteTelefone', 'editClienteEmail',
    'editClienteCep', 'editClienteLogradouro', 'editClienteNumero', 
    'editClienteBairro', 'editClienteCidade'
  ];

  campos.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.readOnly = false;
      el.classList.remove('input-travado');
      el.classList.add('input-editavel'); // Para ficar com a borda verde, se tiver o CSS
    }
  });

  // Mostra o botão de salvar
  document.getElementById('btnSalvarCliente').style.display = 'block';
}

async function buscarClientePorCPF(cpf) {
  const cpfLimpo = cpf.replace(/\D/g, '');
  if (cpfLimpo.length < 11) return; 

  try {
    const response = await fetch(`${SB_URL}/clientes?cpf_cnpj=eq.${cpfLimpo}`, {
      method: 'GET',
      headers: {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`,
        'Content-Type': 'application/json'
      }
    });

    const dados = await response.json();

    if (dados && dados.length > 0) {
      const cliente = dados[0];
      
      // Preenchimento usando os campos que vêm do seu Banco (Supa)
      // E enviando para os IDs do seu novo Modal
      if(document.getElementById('nomeCliente'))      document.getElementById('nomeCliente').value = cliente.cliente_nome || "";
      if(document.getElementById('telCliente'))       document.getElementById('telCliente').value = cliente.telefone || "";
      if(document.getElementById('clienteEmail'))     document.getElementById('clienteEmail').value = cliente.email || "";
      if(document.getElementById('trabalhoCliente'))  document.getElementById('trabalhoCliente').value = cliente.trabalho || "";
      
      // Endereço
      if(document.getElementById('cepCliente'))       document.getElementById('cepCliente').value = cliente.cep || "";
      if(document.getElementById('ruaCliente'))       document.getElementById('ruaCliente').value = cliente.logradouro || "";
      if(document.getElementById('bairroCliente'))    document.getElementById('bairroCliente').value = cliente.bairro || "";
      if(document.getElementById('cidadeCliente'))    document.getElementById('cidadeCliente').value = cliente.cidade || "";
      if(document.getElementById('numComplemento'))   document.getElementById('numComplemento').value = cliente.numero || "";

      console.log("✅ Cliente " + cliente.cliente_nome + " carregado do Supabase.");
    } else {
      console.log("ℹ️ CPF não encontrado no banco. Pronto para novo cadastro.");
    }
  } catch (error) {
    console.error("❌ Erro na conexão com Supabase:", error);
  }
}


function gerarPreviewEdicao(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const img = document.getElementById('editPreviewFoto');
      const icone = document.getElementById('editIconePadrao');
      
      img.src = e.target.result;
      img.style.display = 'block';
      icone.style.display = 'none';
      
      console.log("✅ Preview da foto gerado com sucesso.");
    }
    
    reader.readAsDataURL(input.files[0]);
  }
}

function ampliarFoto(url) {
    const modal = document.getElementById('modalZoomFoto');
    const img = document.getElementById('fotoAmpliada');
    
    if (url && url !== "") {
        img.src = url;
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
    }
}

async function atualizarFotoDireto(id, input) {
  if (!input.files || !input.files[0]) return;
  
  const arquivo = input.files[0];
  const baseURL = SB_URL.replace('/rest/v1', '');
  const nomeArquivo = `${id}_direto_${Date.now()}.${arquivo.name.split('.').pop()}`;

  // 1. Localiza a imagem na tabela e guarda a URL ANTIGA para deletar
  const imgElement = document.getElementById(`img-tabela-${id}`);
  const urlAntigaParaDeletar = imgElement ? imgElement.src : null;

  if (imgElement) {
    imgElement.style.opacity = "0.3"; // Feedback visual de carregamento
  }

  try {
    // 2. Upload da NOVA foto para o Storage
    const uploadRes = await fetch(`${baseURL}/storage/v1/object/fotos-clientes/${nomeArquivo}`, {
      method: 'POST',
      headers: { 
        'apikey': SB_KEY, 
        'Authorization': `Bearer ${SB_KEY}`, 
        'Content-Type': arquivo.type 
      },
      body: arquivo
    });

    if (!uploadRes.ok) throw new Error("Erro no upload");

    const novaUrl = `${baseURL}/storage/v1/object/public/fotos-clientes/${nomeArquivo}`;

    // 3. Update na Tabela Clientes (Banco de Dados)
    const patchRes = await fetch(`${SB_URL}/clientes?id=eq.${id}`, {
      method: 'PATCH',
      headers: {
        'apikey': SB_KEY,
        'Authorization': `Bearer ${SB_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify({ foto_url: novaUrl })
    });

    if (patchRes.ok) {
      // --- PASSO 4: LIMPEZA DA FOTO ANTIGA NO BUCKET ---
      if (urlAntigaParaDeletar && urlAntigaParaDeletar.includes('fotos-clientes/')) {
        try {
          const nomeAntigo = urlAntigaParaDeletar.split('/').pop().split('?')[0];
          const urlDeExclusao = `${baseURL}/storage/v1/object/fotos-clientes/${nomeAntigo}`;
          
          await fetch(urlDeExclusao, {
            method: 'DELETE',
            headers: {
              'apikey': SB_KEY,
              'Authorization': `Bearer ${SB_KEY}`
            }
          });
          console.log("🧹 Foto antiga removida com sucesso.");
        } catch (e) {
          console.warn("Aviso: Foto nova salva, mas a antiga não pôde ser removida.");
        }
      }

      // --- PASSO 5: ATUALIZAÇÃO AUTOMÁTICA DA LISTA ---
      if (typeof mostrarLista === 'function') {
        console.log("🔄 Recarregando lista de clientes para sincronizar dados...");
        await mostrarLista('cadastro-clientes');
      }

      console.log("✅ Foto atualizada, bucket limpo e lista sincronizada!");
    }

  } catch (err) {
    console.error(err);
    alert("Erro ao trocar foto rápida.");
    if (imgElement) imgElement.style.opacity = "1";
  }
}

async function confirmarExclusaoCliente(id, nomeCliente) {
    const mensagem = `⚠️ Tem certeza que deseja excluir o cliente "${nomeCliente}"?\nEsta ação também apagará a foto dele e não pode ser desfeita.`;
    
    if (!confirm(mensagem)) return;

    try {
        const listaClientes = window.dadosPlanilha || []; 
        const cliente = listaClientes.find(c => String(c.id) === String(id));
        const urlFoto = cliente ? cliente.foto_url : null;

        // --- 1. PRIMEIRO REMOVEMOS DO STORAGE (BUCKET) ---
        if (urlFoto && urlFoto.includes('fotos-clientes')) {
            try {
                const nomeArquivo = urlFoto.split('/').pop();
                const baseURL = SB_URL.replace('/rest/v1', '');
                
                await fetch(`${baseURL}/storage/v1/object/fotos-clientes/${nomeArquivo}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SB_KEY,
                        'Authorization': `Bearer ${SB_KEY}`
                    }
                });
                console.log("Foto removida do storage com sucesso.");
            } catch (errFoto) {
                console.warn("Não foi possível apagar a foto física, mas prosseguindo com a exclusão do registro:", errFoto);
            }
        }

        // --- 2. DEPOIS REMOVEMOS DO BANCO DE DADOS ---
        const response = await fetch(`${SB_URL}/clientes?id=eq.${id}`, {
            method: 'DELETE',
            headers: {
                'apikey': SB_KEY,
                'Authorization': `Bearer ${SB_KEY}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            const erroTxt = await response.text();
            throw new Error("Erro no banco: " + erroTxt);
        }

        alert(`✅ Cliente "${nomeCliente}" removido com sucesso!`);

        if (typeof mostrarLista === 'function') {
            await mostrarLista('cadastro-clientes');
        } else {
            location.reload();
        }

    } catch (error) {
        console.error("Erro na exclusão:", error);
        alert("Erro ao excluir: " + error.message);
    }
}


function previewImagemProduto(input, idPreview) {
    const preview = document.getElementById(idPreview);
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            preview.style.width = '60px'; // Garante o tamanho da miniatura
            preview.style.height = '60px';
            preview.style.objectFit = 'cover';
        }
        reader.readAsDataURL(input.files[0]);
    }
}

// 1. VERSÃO PARA NOVO PRODUTO
function executarUploadProduto(input) {
  if (!input.files || input.files.length === 0) return;
  
  // Guardamos o arquivo na variável global (mesma usada na edição)
  arquivoTemporarioEdicao = input.files[0];
  
  const inputUrl = document.getElementById('p_url');
  if (inputUrl) {
    // Apenas visual: avisa que o arquivo foi pego, mas não enviado ainda
    inputUrl.value = "Pendente: " + arquivoTemporarioEdicao.name;
    inputUrl.style.border = "2px solid #38bdf8";
  }
}

// 2. VERSÃO PARA EDIÇÃO

function executarUploadProdutoEdicao(input) {
  if (!input.files || input.files.length === 0) return;
  
  // Guarda o arquivo bruto para ser enviado depois
  arquivoTemporarioEdicao = input.files[0];
  
  const inputUrl = document.getElementById('editProdUrl');
  if (inputUrl) {
    // Apenas um aviso visual, esse texto NÃO vai para o banco
    inputUrl.value = "Pendente: " + arquivoTemporarioEdicao.name;
    inputUrl.style.color = "#f59e0b"; 
  }
}




// 3. CENTRAL DE ATALHOS (ENTER E ESC)
function configurarAtalhos() {
  // Foco inicial no login
  const campoUser = document.getElementById('usuario');
  if (campoUser) setTimeout(() => campoUser.focus(), 500);

  document.addEventListener('keydown', function(event) {
    const modalAviso = document.getElementById('modalAviso');
    const loginScreen = document.getElementById('loginScreen');
    const vendasScreen = document.getElementById('vendasScreen');
    const resumoVenda = document.getElementById('resumoVenda') || document.getElementById('modalResumo');

    // --- TECLA ESC: FECHA TUDO ---
    if (event.key === "Escape") {
      const modais = ['modalAviso', 'modalEsqueci', 'modalSenha', 'modalConfirmarVenda', 'modalExcluir'];
      modais.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });

      if (vendasScreen && vendasScreen.style.display !== 'none') {
        if (typeof navegar === 'function') {
          navegar('dashboard');
        } else {
          vendasScreen.style.display = 'none';
          if(document.getElementById('dashboard')) document.getElementById('dashboard').style.display = 'block';
        }
      }
      if (resumoVenda) resumoVenda.style.display = 'none';
    }

    // --- TECLA ENTER: LOGIN E OK ---
    if (event.key === "Enter") {
      if (modalAviso && modalAviso.style.display === 'flex') {
        modalAviso.style.display = 'none';
      } 
      else if (loginScreen && loginScreen.style.display !== 'none') {
        login(); 
      }
    }
  });
}

window.onload = async () => {
  // 1. Configura os atalhos (que você já tinha)
  configurarAtalhos();

  // 2. Tenta carregar as vendas automaticamente ao abrir
  console.log("Carregando dados iniciais...");
  try {
    // Chama a função que busca os dados no Supabase e monta a tabela
    await mostrarLista('cadastro-vendas');
  } catch (error) {
    console.error("Erro ao carregar vendas na inicialização:", error);
  }
};

 </script>
 
</body>
</html>


